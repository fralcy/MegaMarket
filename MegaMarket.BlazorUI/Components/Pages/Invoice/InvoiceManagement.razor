@page "/invoice"

@inject IHttpClientFactory HttpClientFactory
@using System.Globalization
@using System.ComponentModel.DataAnnotations
@using System.ComponentModel.DataAnnotations.Schema
@using MegaMarket.API.DTOs.Invoice

<div class="invoice-container">
    <h2>Invoice Mangagement</h2>

    <div class="search-area">
        <h4>Search</h4>
        <div class="search-input-group">
            <label for="searchId">Invoice ID:</label>
            <input id="searchId" @bind="SearchInvoiceId" placeholder="Input invoice ID" />

            <label for="searchDate">Created at:</label>
            <input id="searchDate" @bind="SearchDate" type="date" />

            <button class="btn-primary" @onclick="ApplyFilter">Search</button>
            <button class="btn-secondary" @onclick="ClearFilter">Clear filter</button>
        </div>
    </div>

    <div class="invoice-grid">
        <div>
            <h4>Invoice list (@FilteredInvoices.Count)</h4>
            <table class="table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f1f1f1;">
                        <th style="padding: 10px; border: 1px solid #ddd;">ID</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Created at</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Total</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">TT</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var invoice in FilteredInvoices)
                    {
                        <tr style="@(SelectedInvoice?.InvoiceId == invoice.InvoiceId ? "background-color: #e0f7fa;" : "")" @onclick="() => SelectInvoice(invoice.InvoiceId)">
                            <td style="padding: 10px; border: 1px solid #ddd;">@invoice.InvoiceId</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">@invoice.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">@FormatCurrency(invoice.TotalAmount)</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">@invoice.PaymentMethod</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">
                                <button class="btn-success" @onclick="() => ShowPrintPreview(invoice.InvoiceId)">In HĐ</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="detail-view">
            @if (SelectedInvoice != null)
            {
                <h4>Invoice Detail #@SelectedInvoice.InvoiceId</h4>

                <div class="detail-section">
                    <strong>Overview</strong>
                    <div class="detail-row"><span>User:</span> <span>@SelectedInvoice.User.Username</span></div>
                    <div class="detail-row"><span>Customer:</span> <span>@(SelectedInvoice.Customer?.FullName ?? "Khách lẻ")</span></div>
                    <div class="detail-row"><span>Created at:</span> <span>@SelectedInvoice.CreatedAt.ToString("dd/MM/yyyy HH:mm:ss")</span></div>
                    <div class="detail-row"><span>Method:</span> <span>@SelectedInvoice.PaymentMethod</span></div>
                    <div class="detail-row"><span>Status:</span> <span>@SelectedInvoice.Status</span></div>
                </div>

                <div class="detail-section">
                    <strong>Product detail</strong>
                    <table style="width: 100%; font-size: 0.9em; margin-top: 5px;">
                        @foreach (var detail in SelectedInvoice.InvoiceDetails)
                        {
                            <tr>
                                <td>@detail.Product.Name (@detail.Quantity)</td>
                                <td style="text-align: right;">@FormatCurrency(detail.Quantity * detail.UnitPrice)</td>
                            </tr>
                        }
                    </table>
                </div>

                <div class="detail-section">
                    <strong>Summary</strong>
                    <div class="detail-row"><span>Total before discount:</span> <span>@FormatCurrency(SelectedInvoice.TotalBeforeDiscount)</span></div>
                    <div class="detail-row"><span>Promotion ID:</span> <span>@(SelectedInvoice.Promotion?.Name ?? "Không")</span></div>
                    <div class="detail-row"><span>Received amount:</span> <span>@FormatCurrency(SelectedInvoice.ReceivedAmount)</span></div>
                    <div class="detail-row"><span>Change amount:</span> <span>@FormatCurrency(SelectedInvoice.ChangeAmount)</span></div>
                    <div class="detail-row" style="font-weight: bold;"><span>Total amount:</span> <span>@FormatCurrency(SelectedInvoice.TotalAmount)</span></div>
                </div>
            }
            else
            {
                <p style="text-align: center; color: #6c757d;">Please select a invoice.</p>
            }
        </div>
    </div>
</div>

@if (IsPrintModalVisible && InvoiceToPrint != null)
{
    <div class="print-modal" @onclick="HidePrintPreview">
        <div class="print-content" @onclick:stopPropagation="true">
            <div class="receipt-header">
                <strong>SIÊU THỊ MAXIMART</strong><br />
                <small>Địa chỉ: 123 Lê Lợi, TP.HCM</small><br />
                <small>ĐT: 028 1234 5678</small>
            </div>

            <div class="receipt-divider"></div>

            <div class="receipt-line"><span>Mã HĐ:</span> <span>#@InvoiceToPrint.InvoiceId</span></div>
            <div class="receipt-line"><span>Ngày:</span> <span>@InvoiceToPrint.CreatedAt.ToString("dd/MM/yyyy HH:mm:ss")</span></div>
            <div class="receipt-line"><span>NV:</span> <span>@InvoiceToPrint.User.FullName</span></div>
            <div class="receipt-line"><span>KH:</span> <span>@(InvoiceToPrint.Customer?.FullName ?? "Khách lẻ")</span></div>

            <div class="receipt-divider"></div>

            @foreach (var detail in InvoiceToPrint.InvoiceDetails)
            {
                <div class="receipt-line">
                    <span>@detail.Product.Name</span>
                    <span>@detail.Quantity x @FormatCurrency(detail.UnitPrice)</span>
                </div>
                <div class="receipt-line">
                    <span style="font-size: 0.8em;">KM: @FormatCurrency(detail.DiscountPerUnit)</span>
                    <span style="text-align: right;">@FormatCurrency(detail.Quantity * (detail.UnitPrice - detail.DiscountPerUnit))</span>
                </div>
            }

            <div class="receipt-divider"></div>

            <div class="receipt-line"><span>Tổng (trước KM):</span> <span>@FormatCurrency(InvoiceToPrint.TotalBeforeDiscount)</span></div>
            <div class="receipt-line"><span>Khuyến mãi:</span> <span>@FormatCurrency(InvoiceToPrint.TotalBeforeDiscount - InvoiceToPrint.TotalAmount)</span></div>
            <div class="receipt-line receipt-total"><span>TỔNG CỘNG:</span> <span>@FormatCurrency(InvoiceToPrint.TotalAmount)</span></div>

            <div class="receipt-divider"></div>

            <div class="receipt-line"><span>Thanh toán:</span> <span>@InvoiceToPrint.PaymentMethod</span></div>
            <div class="receipt-line"><span>Tiền nhận:</span> <span>@FormatCurrency(InvoiceToPrint.ReceivedAmount)</span></div>
            <div class="receipt-line"><span>Tiền thừa:</span> <span>@FormatCurrency(InvoiceToPrint.ChangeAmount)</span></div>

            <div class="receipt-footer">
                <p>Cảm ơn quý khách!</p>
                <small>Hóa đơn không phải là biên lai chính thức</small>
            </div>

            <button class="btn-primary" style="width: 100%; margin-top: 15px;" @onclick="PrintReceipt">Print</button>
            <button class="btn-secondary" style="width: 100%; margin-top: 5px;" @onclick="HidePrintPreview">Close</button>
        </div>
    </div>
}


@code {
    // -----------------------------------------------------------------------
    // STATE VÀ DỮ LIỆU
    // -----------------------------------------------------------------------

    private List<InvoiceResDto> AllInvoices { get; set; } = new List<InvoiceResDto>();
    private List<InvoiceResDto> FilteredInvoices { get; set; } = new List<InvoiceResDto>();
    private InvoiceResDto? SelectedInvoice { get; set; }
    private InvoiceResDto? InvoiceToPrint { get; set; }

    private string SearchInvoiceId { get; set; } = "";
    private DateTime? SearchDate { get; set; }

    // Trạng thái modal in
    private bool IsPrintModalVisible { get; set; } = false;

    [Inject]
    public IJSRuntime JSRuntime { get; set; } = default!;

    // -----------------------------------------------------------------------
    // LIFECYCLE VÀ KHỞI TẠO DỮ LIỆU MẪU
    // -----------------------------------------------------------------------

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("MegaMarket.API");
            AllInvoices = await client.GetFromJsonAsync<List<InvoiceResDto>>("api/Invoice") ?? new List<InvoiceResDto>();
            FilteredInvoices = AllInvoices;
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error fetching invoices: {ex.Message}");
			AllInvoices = new List<InvoiceResDto>();
		}
    }

    // -----------------------------------------------------------------------
    // HÀM HỖ TRỢ HIỂN THỊ
    // -----------------------------------------------------------------------
    private string FormatCurrency(decimal amount)
    {
        var culture = new CultureInfo("vi-VN");
        return string.Format(culture, "{0:N0} VNĐ", amount);
    }

    // -----------------------------------------------------------------------
    // LOGIC TÌM KIẾM VÀ DANH SÁCH
    // -----------------------------------------------------------------------
    private void SelectInvoice(int id)
    {
        SelectedInvoice = AllInvoices.FirstOrDefault(i => i.InvoiceId == id);
    }

    private void ApplyFilter()
    {
        IEnumerable<InvoiceResDto> query = AllInvoices;

        // Lọc theo Mã hóa đơn
        if (!string.IsNullOrWhiteSpace(SearchInvoiceId) && int.TryParse(SearchInvoiceId, out var id))
        {
            query = query.Where(i => i.InvoiceId == id);
        }

        // Lọc theo Ngày tạo hóa đơn CreatedAt
        if (SearchDate.HasValue)
        {
            // So sánh chỉ phần ngày (Date)
            query = query.Where(i => i.CreatedAt.Date == SearchDate.Value.Date);
        }

        FilteredInvoices = query.ToList();
        SelectedInvoice = null; // Reset chi tiết khi filter
    }

    private void ClearFilter()
    {
        SearchInvoiceId = "";
        SearchDate = null;
        FilteredInvoices = AllInvoices;
        SelectedInvoice = null;
    }

    // -----------------------------------------------------------------------
    // LOGIC IN HÓA ĐƠN
    // -----------------------------------------------------------------------
    private void ShowPrintPreview(int id)
    {
        InvoiceToPrint = AllInvoices.FirstOrDefault(i => i.InvoiceId == id);
        if (InvoiceToPrint != null)
        {
            IsPrintModalVisible = true;
        }
    }

    private void HidePrintPreview()
    {
        IsPrintModalVisible = false;
        InvoiceToPrint = null;
    }

    private async Task PrintReceipt()
    {
        if (InvoiceToPrint == null) return;

        // **Lưu ý:** Trong ứng dụng thực tế, bạn sẽ cần thư viện JS hoặc CSS media print
        // để chỉ in nội dung hóa đơn (receipt-content)
        await JSRuntime.InvokeVoidAsync("alert", $"Đang gửi lệnh in hóa đơn #{InvoiceToPrint.InvoiceId}");

        // Giả lập lệnh in thực tế (chỉ đóng modal)
        // await JSRuntime.InvokeVoidAsync("window.print");

        HidePrintPreview();
    }
}