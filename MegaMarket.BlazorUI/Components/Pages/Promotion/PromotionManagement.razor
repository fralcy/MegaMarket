@page "/promotion"
@using System.ComponentModel.DataAnnotations
@using System.ComponentModel.DataAnnotations.Schema
@using System.Globalization

## 🎁 Quản Lý Chương Trình Khuyến Mãi

@if (IsEditing)
{
    <div class="edit-form">
        <h3>@(CurrentPromotion.PromotionId == 0 ? "Thêm Khuyến Mãi Mới" : $"Chỉnh Sửa: {CurrentPromotion.Name}")</h3>

        <EditForm Model="@CurrentPromotion" OnValidSubmit="SavePromotion">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label>Tên Khuyến Mãi:</label>
                <InputText @bind-Value="CurrentPromotion.Name" class="form-control" />
                <ValidationMessage For="@(() => CurrentPromotion.Name)" />
            </div>

            <div class="form-group">
                <label>Mô Tả:</label>
                <InputTextArea @bind-Value="CurrentPromotion.Description" class="form-control" />
            </div>

            <div class="form-group">
                <label>Loại Giảm Giá:</label>
                <InputSelect @bind-Value="CurrentPromotion.DiscountType" class="form-control">
                    <option value="percent">Phần trăm (%)</option>
                    <option value="fixed">Số tiền cố định (VNĐ)</option>
                </InputSelect>
            </div>

            <div class="form-group">
                <label>Giá Trị Giảm Giá:</label>
                <InputNumber @bind-Value="CurrentPromotion.DiscountValue" class="form-control" />
                <ValidationMessage For="@(() => CurrentPromotion.DiscountValue)" />
            </div>

            <div class="form-group">
                <label>Ngày Bắt Đầu:</label>
                <InputDate @bind-Value="CurrentPromotion.StartDate" class="form-control" />
                <ValidationMessage For="@(() => CurrentPromotion.StartDate)" />
            </div>

            <div class="form-group">
                <label>Ngày Kết Thúc:</label>
                <InputDate @bind-Value="CurrentPromotion.EndDate" class="form-control" />
                <ValidationMessage For="@(() => CurrentPromotion.EndDate)" />
            </div>

            <div class="form-group">
                <label>Áp Dụng Cho:</label>
                <InputSelect @bind-Value="CurrentPromotion.Type" class="form-control">
                    <option value="invoice">Toàn bộ Hóa đơn</option>
                    <option value="product">Sản phẩm cụ thể</option>
                    <option value="promotion">Khác</option>
                </InputSelect>
            </div>

            <button type="submit" class="btn-primary btn-action">Lưu</button>
            <button type="button" class="btn-secondary btn-action" @onclick="CancelEdit">Hủy</button>
        </EditForm>
    </div>
}

<div class="promotion-list">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h4>Danh Sách (@Promotions.Count)</h4>
        <button class="btn-success btn-action" @onclick="StartNewPromotion">➕ Thêm Mới</button>
    </div>

    @if (Promotions.Any())
    {
        <table class="table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f1f1f1;">
                    <th style="padding: 10px; border: 1px solid #ddd;">ID</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Tên</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Giá trị</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Thời gian</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Áp dụng</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var promo in Promotions)
                {
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">@promo.PromotionId</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">@promo.Name</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            @GetDiscountDisplay(promo)
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-size: 0.9em;">
                            @promo.StartDate.ToShortDateString() - @promo.EndDate.ToShortDateString()
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            @GetTypeDisplay(promo.Type)
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            <button class="btn-primary btn-action" @onclick="() => StartEdit(promo.PromotionId)">Sửa</button>
                            <button class="btn-danger btn-action" @onclick="() => DeletePromotion(promo.PromotionId)">Xóa</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p style="text-align: center; color: #6c757d;">Chưa có chương trình khuyến mãi nào được tạo.</p>
    }
</div>

@code {
    // -----------------------------------------------------------------------
    // MODEL DỮ LIỆU
    // -----------------------------------------------------------------------
    public class Promotion
    {
        [Key]
        [Column("promotion_id")]
        public int PromotionId { get; set; }

        [Required(ErrorMessage = "Tên khuyến mãi là bắt buộc.")]
        [StringLength(200)]
        [Column("name")]
        public string Name { get; set; } = string.Empty;

        [Column("description")]
        public string? Description { get; set; }

        [Required]
        [StringLength(20)]
        [Column("discount_type")]
        public string DiscountType { get; set; } = "percent"; // percent / fixed

        [Required]
        [Range(0.01, 1000000000, ErrorMessage = "Giá trị giảm giá phải lớn hơn 0.")]
        [Column("discount_value", TypeName = "decimal(10,2)")]
        public decimal DiscountValue { get; set; }

        [Required(ErrorMessage = "Ngày bắt đầu là bắt buộc.")]
        [Column("start_date")]
        public DateTime StartDate { get; set; } = DateTime.Today;

        [Required(ErrorMessage = "Ngày kết thúc là bắt buộc.")]
        [Column("end_date")]
        public DateTime EndDate { get; set; } = DateTime.Today.AddDays(7);

        [Required]
        [StringLength(50)]
        [Column("type")]
        public string Type { get; set; } = "invoice"; // invoice / product / promotion

        // Navigation properties (Không dùng trong CRUD UI này, chỉ giữ lại định nghĩa)
        public ICollection<Invoice> Invoices { get; set; } = new List<Invoice>();
        public ICollection<InvoiceDetail> InvoiceDetails { get; set; } = new List<InvoiceDetail>();
        public ICollection<PromotionProduct> PromotionProducts { get; set; } = new List<PromotionProduct>();
    }

    // Định nghĩa các lớp giả định cho Navigation properties
    public class Invoice { }
    public class InvoiceDetail { }
    public class PromotionProduct { }


    // -----------------------------------------------------------------------
    // STATE (Trạng thái)
    // -----------------------------------------------------------------------

    private List<Promotion> Promotions { get; set; } = new List<Promotion>();
    private Promotion CurrentPromotion { get; set; } = new Promotion();
    private bool IsEditing { get; set; } = false;
    private int NextId = 1;

    // -----------------------------------------------------------------------
    // LIFECYCLE VÀ KHỞI TẠO DỮ LIỆU
    // -----------------------------------------------------------------------

    protected override void OnInitialized()
    {
        // Khởi tạo dữ liệu mẫu
        Promotions.Add(new Promotion { PromotionId = NextId++, Name = "Giảm 10% Hóa đơn", DiscountType = "percent", DiscountValue = 10, StartDate = DateTime.Today, EndDate = DateTime.Today.AddDays(30), Type = "invoice", Description = "Giảm 10% cho toàn bộ hóa đơn." });
        Promotions.Add(new Promotion { PromotionId = NextId++, Name = "Giảm giá Trứng Gà", DiscountType = "fixed", DiscountValue = 5000, StartDate = DateTime.Today.AddDays(-10), EndDate = DateTime.Today.AddDays(5), Type = "product", Description = "Giảm 5,000 VNĐ cho mỗi hộp Trứng Gà." });
    }

    // -----------------------------------------------------------------------
    // HÀM HỖ TRỢ HIỂN THỊ
    // -----------------------------------------------------------------------

    private string GetDiscountDisplay(Promotion promo)
    {
        if (promo.DiscountType == "percent")
        {
            return $"{promo.DiscountValue:N0}%";
        }
        else if (promo.DiscountType == "fixed")
        {
            // Sử dụng định dạng tiền tệ Việt Nam
            var culture = new CultureInfo("vi-VN");
            return string.Format(culture, "{0:N0} VNĐ", promo.DiscountValue);
        }
        return "N/A";
    }

    private string GetTypeDisplay(string type)
    {
        return type switch
        {
            "invoice" => "Toàn bộ Hóa đơn",
            "product" => "Sản phẩm cụ thể",
            _ => "Khác",
        };
    }

    // -----------------------------------------------------------------------
    // HÀM CRUD LOGIC
    // -----------------------------------------------------------------------

    // Bắt đầu chế độ Thêm mới
    private void StartNewPromotion()
    {
        CurrentPromotion = new Promotion();
        IsEditing = true;
    }

    // Bắt đầu chế độ Chỉnh sửa
    private void StartEdit(int id)
    {
        var promoToEdit = Promotions.FirstOrDefault(p => p.PromotionId == id);
        if (promoToEdit != null)
        {
            // Tạo bản sao để tránh thay đổi trực tiếp vào danh sách khi chưa lưu
            CurrentPromotion = new Promotion
            {
                PromotionId = promoToEdit.PromotionId,
                Name = promoToEdit.Name,
                Description = promoToEdit.Description,
                DiscountType = promoToEdit.DiscountType,
                DiscountValue = promoToEdit.DiscountValue,
                StartDate = promoToEdit.StartDate,
                EndDate = promoToEdit.EndDate,
                Type = promoToEdit.Type
            };
            IsEditing = true;
        }
    }

    // Lưu (Create hoặc Update)
    private void SavePromotion()
    {
        if (CurrentPromotion.PromotionId == 0)
        {
            // Thêm mới (Create)
            CurrentPromotion.PromotionId = NextId++;
            Promotions.Add(CurrentPromotion);
            Console.WriteLine($"Đã thêm mới Khuyến Mãi: {CurrentPromotion.Name}");
        }
        else
        {
            // Cập nhật (Update)
            var index = Promotions.FindIndex(p => p.PromotionId == CurrentPromotion.PromotionId);
            if (index != -1)
            {
                Promotions[index] = CurrentPromotion;
                Console.WriteLine($"Đã cập nhật Khuyến Mãi ID: {CurrentPromotion.PromotionId}");
            }
        }

        IsEditing = false;
        // Reset CurrentPromotion sau khi lưu thành công (tùy chọn)
        CurrentPromotion = new Promotion();
    }

    // Hủy bỏ chỉnh sửa/thêm mới
    private void CancelEdit()
    {
        IsEditing = false;
        CurrentPromotion = new Promotion();
    }

    // Xóa (Delete)
    private async Task DeletePromotion(int id)
    {
        var promoToDelete = Promotions.FirstOrDefault(p => p.PromotionId == id);

        if (promoToDelete != null)
        {
            // Sử dụng JSRuntime.InvokeAsync<bool> để gọi window.confirm
            bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
                                                            $"Bạn có chắc chắn muốn xóa khuyến mãi '{promoToDelete.Name}' không?");

            if (confirmed)
            {
                Promotions.Remove(promoToDelete);
                Console.WriteLine($"Đã xóa Khuyến Mãi ID: {id}");
            }
        }
    }

    // Inject IJSRuntime để dùng hàm xác nhận của trình duyệt
    [Inject]
    public IJSRuntime JSRuntime { get; set; } = default!;
}