@page "/promotion"

@inject IHttpClientFactory HttpClientFactory
@using System.ComponentModel.DataAnnotations
@using System.ComponentModel.DataAnnotations.Schema
@using System.Globalization
@using MegaMarket.API.DTOs.Products
@using MegaMarket.API.DTOs.Promotion

<div class="promotion-container">
    <h2>Promotion Management</h2>

    @if (!IsEditing)
    {
        <div class="promotion-list">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4>Danh Sách (@Promotions.Count)</h4>
                <button class="btn-success btn-action" @onclick="StartNewPromotion">➕ Create</button>
            </div>

            @if (Promotions.Any())
            {
                <table class="table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f1f1f1;">
                            <th style="padding: 10px; border: 1px solid #ddd;">ID</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Name</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Value</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Time</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Apply</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Operation</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var promo in Promotions)
                        {
                            <tr>
                                <td style="padding: 10px; border: 1px solid #ddd;">@promo.PromotionId</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">@promo.Name</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">
                                    @GetDiscountDisplay(promo)
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd; font-size: 0.9em;">
                                    @promo.StartDate.ToShortDateString() - @promo.EndDate.ToShortDateString()
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd;">
                                    @GetTypeDisplay(promo.Type)
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd;">
                                    <button class="btn-primary btn-action" @onclick="() => StartEdit(promo.PromotionId)">Edit</button>
                                    <button class="btn-danger btn-action" @onclick="() => DeletePromotion(promo.PromotionId)">Delete</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p style="text-align: center; color: #6c757d;">No value</p>
            }
        </div>
	}
    else
    {
        <div class="edit-form">
            <h3>@(CurrentPromotionId == 0 ? "Add new promotion" : $"Edit: {CurrentPromotion.Name}")</h3>

            <EditForm Model="@CurrentPromotion" OnValidSubmit="SavePromotion">
                <DataAnnotationsValidator />

                <div class="form-group">
                    <label>Name:</label>
                    <InputText @bind-Value="CurrentPromotion.Name" class="form-control" />
                    <ValidationMessage For="@(() => CurrentPromotion.Name)" />
                </div>

                <div class="form-group">
                    <label>Description:</label>
                    <InputTextArea @bind-Value="CurrentPromotion.Description" class="form-control" />
                </div>

                <div class="form-group">
                    <label>Apply:</label>
                    <InputSelect @bind-Value="CurrentPromotion.Type" class="form-control">
                        <option value="invoice">Invoice</option>
                        <option value="product">Product</option>
                        <option value="promotion">Promotion</option>
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label>Discount type:</label>
                    <InputSelect @bind-Value="CurrentPromotion.DiscountType" class="form-control">
                        @if(CurrentPromotion.Type == "invoice")
                        {
                            <option value="percent">Percent (%)</option>
						}
                        <option value="fixed">Fixed (VNĐ)</option>
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label>Discount value:</label>
                    <InputNumber @bind-Value="CurrentPromotion.DiscountValue" class="form-control" />
                    <ValidationMessage For="@(() => CurrentPromotion.DiscountValue)" />
                </div>

                <div class="form-group">
                    <label>Start date:</label>
                    <InputDate @bind-Value="CurrentPromotion.StartDate" class="form-control" />
                    <ValidationMessage For="@(() => CurrentPromotion.StartDate)" />
                </div>

                <div class="form-group">
                    <label>End date:</label>
                    <InputDate @bind-Value="CurrentPromotion.EndDate" class="form-control" />
                    <ValidationMessage For="@(() => CurrentPromotion.EndDate)" />
                </div>
            </EditForm>

            @if (CurrentPromotion.Type == "product")
            {
                <div class="form-group">
                    <label for="product">Barcode: </label>
                    <input id="product"
                            type="number"
                            value="@Barcode"
                            @oninput="HandleBarcode" />
                </div>

                <div class="form-group">
                    <label>Product name: </label>
                    <span>@ProductName</span>
                </div>

                <button disabled="@(!IsBarcodeValid)" @onclick="AddBarcode">Add</button>
            }

            <div class="action-buttons">
                <button type="submit" class="btn-primary btn-action" @onclick="SavePromotion">Save</button>
                <button type="button" class="btn-secondary btn-action" @onclick="CancelEdit">Cancel</button>
            </div>
        </div>
	}
</div>

@code {
    // -----------------------------------------------------------------------
    // STATE (Trạng thái)
    // -----------------------------------------------------------------------

    private List<PromotionResDto> Promotions { get; set; } = new List<PromotionResDto>();
    private PromotionReqDto CurrentPromotion { get; set; } = new PromotionReqDto();
    private List<ProductDto> Products = new List<ProductDto>();
    private Dictionary<string, ProductDto> ProductDB;
    private int CurrentPromotionId { get; set; } = 0;
    private bool IsEditing { get; set; } = false;
    private string Barcode { get; set; } = string.Empty;
    private bool IsBarcodeValid { get; set; } = false;
    private List<int> ProductList { get; set; } = new List<int>();
    private string ProductName { get; set; } = string.Empty;

    // -----------------------------------------------------------------------
    // LIFECYCLE VÀ KHỞI TẠO DỮ LIỆU
    // -----------------------------------------------------------------------

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("MegaMarket.API");
            Promotions = await client.GetFromJsonAsync<List<PromotionResDto>>("api/Promotion") ?? new List<PromotionResDto>();
            Products = await client.GetFromJsonAsync<List<ProductDto>>("api/Products") ?? new List<ProductDto>();
            ProductDB = Products.ToDictionary(p => p.Barcode, p => p);
            Console.WriteLine($"Đã tải {Promotions.Count} khuyến mãi.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Lỗi khi tải danh sách khuyến mãi: {ex.Message}");
            Promotions = new List<PromotionResDto>();
            Products = new List<ProductDto>();
            ProductDB = new Dictionary<string, ProductDto>();
        }
    }

    // -----------------------------------------------------------------------
    // HÀM HỖ TRỢ HIỂN THỊ
    // -----------------------------------------------------------------------

    private string GetDiscountDisplay(PromotionResDto promo)
    {
        if (promo.DiscountType == "percent")
        {
            return $"{promo.DiscountValue:N0}%";
        }
        else if (promo.DiscountType == "fixed")
        {
            // Sử dụng định dạng tiền tệ Việt Nam
            var culture = new CultureInfo("vi-VN");
            return string.Format(culture, "{0:N0} VNĐ", promo.DiscountValue);
        }
        return "N/A";
    }

    private string GetTypeDisplay(string type)
    {
        return type switch
        {
            "invoice" => "Toàn bộ Hóa đơn",
            "product" => "Sản phẩm cụ thể",
            _ => "Khác",
        };
    }

    private void HandleBarcode(ChangeEventArgs e)
    {
        Barcode = e.Value?.ToString() ?? string.Empty;
        if (ProductDB.TryGetValue(Barcode, out var product))
        {
            IsBarcodeValid = true;
            ProductName = product.Name;
        }
        else
        {
            IsBarcodeValid = false;
            ProductName = string.Empty;
        }
    }

    private void AddBarcode()
    {
        if (ProductDB.TryGetValue(Barcode, out var product))
        {
            ProductList.Add(product.ProductId);
            Barcode = string.Empty;
            ProductName = string.Empty;
            IsBarcodeValid = false;
            Console.WriteLine("Added barcode to promotion: " + string.Join(", ", ProductList));
        }
    }

    private bool isPercent()
    {
        if(CurrentPromotion.Type == "product")
        {
            return false;
        }
        return true;
    }

    // -----------------------------------------------------------------------
    // HÀM CRUD LOGIC
    // -----------------------------------------------------------------------

    // Bắt đầu chế độ Thêm mới
    private void StartNewPromotion()
    {
        CurrentPromotion = new PromotionReqDto();
        IsEditing = true;
    }

    // Bắt đầu chế độ Chỉnh sửa
    private void StartEdit(int id)
    {
        var promoToEdit = Promotions.FirstOrDefault(p => p.PromotionId == id);
        CurrentPromotionId = id;
        if (promoToEdit != null)
        {
            // Tạo bản sao để tránh thay đổi trực tiếp vào danh sách khi chưa lưu
            CurrentPromotion = new PromotionReqDto
            {
                Name = promoToEdit.Name,
                Description = promoToEdit.Description,
                DiscountType = promoToEdit.DiscountType,
                DiscountValue = promoToEdit.DiscountValue,
                StartDate = promoToEdit.StartDate,
                EndDate = promoToEdit.EndDate,
                Type = promoToEdit.Type
            };
            IsEditing = true;
        }
    }

    // Lưu (Create hoặc Update)
    private async Task SavePromotion()
    {
		CurrentPromotion.PromotionProducts = ProductList;
        if (CurrentPromotionId == 0)
        {
            // Thêm mới (Create)
            var httpClient = HttpClientFactory.CreateClient("MegaMarket.API");
            var response = await httpClient.PostAsJsonAsync("api/Promotion", CurrentPromotion);
            if (response.IsSuccessStatusCode)
            {
                IsEditing = false;
                CurrentPromotion = new PromotionReqDto();
                CurrentPromotionId = 0;
				await OnInitializedAsync(); // Tải lại danh sách sau khi thêm mới
            }
            else
            {
                Console.WriteLine("Lỗi khi thêm mới khuyến mãi.");
            }
        }
        else
        {
			var httpClient = HttpClientFactory.CreateClient("MegaMarket.API");
            var response = await httpClient.PutAsJsonAsync($"api/Promotion/{CurrentPromotionId}", CurrentPromotion);
            if (response.IsSuccessStatusCode)
            {
                IsEditing = false;
                CurrentPromotion = new PromotionReqDto();
				CurrentPromotionId = 0;
                await OnInitializedAsync(); // Tải lại danh sách sau khi cập nhật
            }
            else
            {
				Console.WriteLine("Lỗi khi cập nhật khuyến mãi.");
            }
        }

		ProductList.Clear();
		ProductName = string.Empty;
    }

    // Hủy bỏ chỉnh sửa/thêm mới
    private void CancelEdit()
    {
        IsEditing = false;
        CurrentPromotion = new PromotionReqDto();
		Barcode = string.Empty;
		ProductList.Clear();
        ProductName = string.Empty;
		CurrentPromotionId = 0;
    }

    // Xóa (Delete)
    private async Task DeletePromotion(int id)
    {
        var promoToDelete = Promotions.FirstOrDefault(p => p.PromotionId == id);

        if (promoToDelete != null)
        {
            // Sử dụng JSRuntime.InvokeAsync<bool> để gọi window.confirm
            bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
                                                            $"Bạn có chắc chắn muốn xóa khuyến mãi '{promoToDelete.Name}' không?");

            if (confirmed)
            {
                var httpClient = HttpClientFactory.CreateClient("MegaMarket.API");
                var response = await httpClient.DeleteAsync($"api/Promotion/{id}");
                if (response.IsSuccessStatusCode)
                {
					await OnInitializedAsync(); // Tải lại danh sách sau khi xóa
                }
                else
                {
                    Console.WriteLine("Lỗi khi xóa khuyến mãi.");
				}
            }
        }
    }

    // Inject IJSRuntime để dùng hàm xác nhận của trình duyệt
    [Inject]
    public IJSRuntime JSRuntime { get; set; } = default!;
}