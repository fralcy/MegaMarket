@page "/admin/employees"
@attribute [Authorize(Roles = "Admin")]
@using MegaMarket.Data.Models
@using MegaMarket.API.DTOs
@inject Services.Users.UsersApiClient UsersApiClient
@inject NavigationManager NavigationManager

<div class="container-fluid">
    @* Header *@
    <div class="row mb-4">
        <div class="col">
            <h2 class="text-gradient">ðŸ‘¥ Employee Management</h2>
            <p class="text-muted small">Manage employees and their information</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="ShowCreateModal">
                <span class="bi bi-plus-circle me-1"></span> Add Employee
            </button>
        </div>
    </div>

    @* Stats Cards *@
    <div class="row mb-4">
        <div class="col-md-4">
            <StatsCard Title="Total Employees"
                       Value="@totalEmployees.ToString()"
                       SubLabel="All users in system"
                       Color="primary" />
        </div>
        <div class="col-md-4">
            <StatsCard Title="Administrators"
                       Value="@adminCount.ToString()"
                       SubLabel="Admin role"
                       Color="success" />
        </div>
        <div class="col-md-4">
            <StatsCard Title="Regular Employees"
                       Value="@employeeCount.ToString()"
                       SubLabel="Employee role"
                       Color="info" />
        </div>
    </div>

    @* Main Content *@
    <div class="row">
        @* Employee List *@
        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Employee List</h5>
                </div>
                <div class="card-body">
                    @if (isLoading)
                    {
                        <LoadingSpinner Message="Loading employees..." />
                    }
                    else if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <ErrorAlert ErrorMessage="@errorMessage" OnDismiss="ClearError" />
                    }
                    else if (employees == null || !employees.Any())
                    {
                        <EmptyState Icon="ðŸ‘¤"
                                    Title="No employees found"
                                    Description="Add your first employee to get started"
                                    ActionText="Add Employee"
                                    OnAction="ShowCreateModal" />
                    }
                    else
                    {
                        <EmployeeList Employees="@employees"
                                      OnEmployeeSelected="HandleEmployeeSelected"
                                      OnEditEmployee="HandleEditEmployee"
                                      OnDeleteEmployee="ShowDeleteConfirmation" />
                    }
                </div>
            </div>
        </div>

        @* Detail Panel *@
        <div class="col-lg-4 mb-4">
            @if (selectedEmployee != null)
            {
                <EmployeeDetailPanel Employee="@selectedEmployee"
                                     OnEdit="() => HandleEditEmployee(selectedEmployee)"
                                     OnDelete="() => ShowDeleteConfirmation(selectedEmployee)" />
            }
            else
            {
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <div class="text-center text-muted">
                            <p style="font-size: 3em;">ðŸ‘ˆ</p>
                            <p>Select an employee to view details</p>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@* Employee Form Modal *@
@if (showFormModal)
{
    <EmployeeFormModal Employee="@employeeToEdit"
                       IsVisible="@showFormModal"
                       OnSave="HandleSaveEmployee"
                       OnCancel="HideFormModal" />
}

@* Delete Confirmation Modal *@
@if (showDeleteModal && employeeToDelete != null)
{
    <ConfirmDialog IsVisible="@showDeleteModal"
                   Title="Delete Employee"
                   Message="@($"Are you sure you want to delete {employeeToDelete.FullName}? This action cannot be undone and will delete all associated attendance records.")"
                   ConfirmText="Delete"
                   OnConfirm="HandleDeleteEmployee"
                   OnCancel="HideDeleteModal" />
}

@code {
    private List<User>? employees;
    private User? selectedEmployee;
    private User? employeeToEdit;
    private User? employeeToDelete;

    private bool isLoading = false;
    private string? errorMessage;
    private bool showFormModal = false;
    private bool showDeleteModal = false;

    private int totalEmployees => employees?.Count ?? 0;
    private int adminCount => employees?.Count(e => e.Role == "Admin") ?? 0;
    private int employeeCount => employees?.Count(e => e.Role == "Employee") ?? 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadEmployees();
    }

    private async Task LoadEmployees()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            employees = await UsersApiClient.GetUsersAsync();

            if (employees == null)
            {
                errorMessage = "Failed to load employees.";
                employees = new List<User>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load employees: {ex.Message}";
            employees = new List<User>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleEmployeeSelected(User employee)
    {
        selectedEmployee = employee;
    }

    private void ShowCreateModal()
    {
        employeeToEdit = null;
        showFormModal = true;
    }

    private void HandleEditEmployee(User employee)
    {
        employeeToEdit = employee;
        showFormModal = true;
    }

    private void HideFormModal()
    {
        showFormModal = false;
        employeeToEdit = null;
    }

    private async Task HandleSaveEmployee(EmployeeFormData formData)
    {
        try
        {
            // Convert form data to DTO
            var input = new UserInputDto
            {
                FullName = formData.FullName,
                Username = formData.Username,
                Password = formData.Password,
                Role = formData.Role,
                Phone = formData.Phone,
                Email = formData.Email
            };

            if (employeeToEdit == null)
            {
                // Create new employee
                await UsersApiClient.CreateUserAsync(input);
            }
            else
            {
                // Update existing employee
                await UsersApiClient.UpdateUserAsync(employeeToEdit.UserId, input);
            }

            HideFormModal();
            await LoadEmployees();

            // Clear selection if we updated the selected employee
            if (selectedEmployee?.UserId == employeeToEdit?.UserId && employeeToEdit != null)
            {
                selectedEmployee = employees?.FirstOrDefault(e => e.UserId == employeeToEdit.UserId);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save employee: {ex.Message}";
        }
    }

    private void ShowDeleteConfirmation(User employee)
    {
        employeeToDelete = employee;
        showDeleteModal = true;
    }

    private void HideDeleteModal()
    {
        showDeleteModal = false;
        employeeToDelete = null;
    }

    private async Task HandleDeleteEmployee()
    {
        if (employeeToDelete == null) return;

        try
        {
            var success = await UsersApiClient.DeleteUserAsync(employeeToDelete.UserId);

            if (!success)
            {
                errorMessage = "Failed to delete employee.";
            }

            HideDeleteModal();
            await LoadEmployees();

            // Clear selection if we deleted the selected employee
            if (selectedEmployee?.UserId == employeeToDelete.UserId)
            {
                selectedEmployee = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete employee: {ex.Message}";
            HideDeleteModal();
        }
    }

    private void ClearError()
    {
        errorMessage = null;
    }

    // Form Data (used by the form modal)
    public class EmployeeFormData
    {
        public string FullName { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
        public string? Password { get; set; }
        public string Role { get; set; } = "Employee";
        public string? Phone { get; set; }
        public string? Email { get; set; }
    }
}
