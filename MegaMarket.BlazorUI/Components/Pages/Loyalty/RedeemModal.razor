@using MegaMarket.BlazorUI.Services.CustomerLoyalty
@inject LoyaltyService LoyaltyService

<div>
    @if (isLoading)
    {
        <div class="alert alert-info">Loading rewards...</div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @errorMessage
        </div>
    }

    <div class="form-group">
        <label for="rewardSelect" class="form-label">Select Reward to Redeem</label>
        <select class="form-select" id="rewardSelect" @bind="selectedRewardId" @bind:event="onchange">
            <option value="0">-- Choose a reward --</option>
            @if (availableRewards != null)
            {
                @foreach (var reward in availableRewards)
                {
                    <option value="@reward.RewardId">
                        @reward.RewardName (@reward.PointCost pts) - @reward.RewardType
                    </option>
                }
            }
        </select>
    </div>

    @if (selectedReward != null)
    {
        <div class="card mt-3 border-info">
            <div class="card-body">
                <h6 class="card-title">@selectedReward.RewardName</h6>
                <p class="card-text">@selectedReward.Description</p>
                <div class="row">
                    <div class="col-6">
                        <p class="text-muted small">Points Required</p>
                        <h5 class="text-danger">@selectedReward.PointCost</h5>
                    </div>
                    <div class="col-6">
                        <p class="text-muted small">Your Points</p>
                        <h5 class="@(CurrentPoints >= selectedReward.PointCost ? "text-success" : "text-danger")">
                            @CurrentPoints
                        </h5>
                    </div>
                </div>

                @if (CurrentPoints < selectedReward.PointCost)
                {
                    <div class="alert alert-warning mt-3 mb-0">
                        ?? You don't have enough points. Need @(selectedReward.PointCost - CurrentPoints) more points.
                    </div>
                }
                else if (selectedReward.QuantityAvailable <= 0)
                {
                    <div class="alert alert-danger mt-3 mb-0">
                        ? This reward is out of stock.
                    </div>
                }
                else
                {
                    <div class="alert alert-success mt-3 mb-0">
                        ? You can redeem this reward!
                    </div>
                }
            </div>
        </div>
    }

    <div class="d-flex gap-2 mt-4">
        <button class="btn btn-primary flex-grow-1" 
                @onclick="RedeemReward"
                disabled="@(selectedRewardId == 0 || selectedReward == null || CurrentPoints < selectedReward.PointCost || selectedReward.QuantityAvailable <= 0)">
            ?? Redeem Now
        </button>
        <button class="btn btn-outline-secondary" @onclick="OnCancel">Cancel</button>
    </div>
</div>

@code {
    [Parameter]
    public int CustomerId { get; set; }

    [Parameter]
    public int CurrentPoints { get; set; }

    [Parameter]
    public EventCallback OnRedeemSuccess { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private List<RewardModel> availableRewards = new();
    private RewardModel? selectedReward = null;
    private int selectedRewardId = 0;
    private bool isLoading = true;
    private string? errorMessage = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadRewards();
    }

    private async Task LoadRewards()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            // Mock data - In production, you'd fetch this from an API
            availableRewards = new List<RewardModel>
            {
                new() { RewardId = 1, RewardName = "Free Coffee", RewardType = "Gift", PointCost = 100, Description = "Get a free coffee at any branch", QuantityAvailable = 50 },
                new() { RewardId = 2, RewardName = "Discount 10%", RewardType = "Discount", PointCost = 200, Description = "10% discount on next purchase", QuantityAvailable = 100 },
                new() { RewardId = 3, RewardName = "Free Meal", RewardType = "Gift", PointCost = 500, Description = "Complimentary meal from our menu", QuantityAvailable = 20 },
                new() { RewardId = 4, RewardName = "Discount 20%", RewardType = "Discount", PointCost = 300, Description = "20% discount on next purchase", QuantityAvailable = 30 },
                new() { RewardId = 5, RewardName = "Voucher 50K", RewardType = "Voucher", PointCost = 800, Description = "50,000 VND voucher", QuantityAvailable = 10 }
            };
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading rewards: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RedeemReward()
    {
        if (selectedRewardId == 0 || selectedReward == null) return;

        try
        {
            var redeemDto = new RedeemRewardDto
            {
                CustomerId = CustomerId,
                RewardId = selectedRewardId,
                InvoiceId = 0
            };

            var result = await LoyaltyService.RedeemRewardAsync(redeemDto);
            errorMessage = null;
            await OnRedeemSuccess.InvokeAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error redeeming reward: {ex.Message}";
        }
    }

    private class RewardModel
    {
        public int RewardId { get; set; }
        public string RewardName { get; set; } = "";
        public string RewardType { get; set; } = "";
        public int PointCost { get; set; }
        public string Description { get; set; } = "";
        public int QuantityAvailable { get; set; }
    }
}
