@page "/employee/dashboard"
@attribute [Authorize(Roles = "Employee")]
@inject Services.GraphQL.GraphQLClient GraphQLClient
@inject AuthenticationStateProvider AuthStateProvider

<div class="container-fluid mt-4">
    @* Header *@
    <div class="mb-4">
        <h2 class="text-gradient mb-1">My Dashboard</h2>
        <p class="text-muted">Welcome back, @currentUserName!</p>
    </div>

    @* Error Message *@
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <ErrorAlert ErrorMessage="@errorMessage" OnDismiss="@(() => errorMessage = null)" />
    }

    @* Loading State *@
    @if (isLoading)
    {
        <LoadingSpinner Message="Loading your dashboard..." />
    }
    else
    {
        @* Today's Status *@
        <div class="row mb-4">
            <div class="col-12">
                @if (todayAttendance != null)
                {
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-4">
                            <h5 class="mb-3"><span class="bi bi-calendar-check me-2"></span>Today's Status</h5>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center p-3">
                                        <div class="text-muted mb-1">Check-In</div>
                                        <h4 class="mb-0">@todayAttendance.CheckIn.ToString("h:mm tt")</h4>
                                        @if (todayAttendance.IsLate)
                                        {
                                            <StatusBadge Status="Late" />
                                        }
                                        else
                                        {
                                            <StatusBadge Status="On Time" />
                                        }
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3">
                                        <div class="text-muted mb-1">Check-Out</div>
                                        <h4 class="mb-0">
                                            @if (todayAttendance.CheckOut != null)
                                            {
                                                @todayAttendance.CheckOut.Value.ToString("h:mm tt")
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not yet</span>
                                            }
                                        </h4>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3">
                                        <div class="text-muted mb-1">Shift</div>
                                        <h4 class="mb-0 fs-6">@todayAttendance.ShiftType?.Name</h4>
                                        <small class="text-muted">@FormatTime(todayAttendance.ShiftType?.StartTime) - @FormatTime(todayAttendance.ShiftType?.EndTime)</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3">
                                        <div class="text-muted mb-1">Work Time</div>
                                        <h4 class="mb-0">@GetWorkingDuration()</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="alert alert-info">
                        <h5><span class="bi bi-info-circle me-2"></span>You haven't checked in today</h5>
                        <p class="mb-2">Start your work day by checking in</p>
                        <a href="/attendance/check-in-out" class="btn btn-primary">
                            <span class="bi bi-calendar-check me-1"></span> Check In Now
                        </a>
                    </div>
                }
            </div>
        </div>

        @* Stats Row *@
        <div class="row mb-4">
            <div class="col-md-3">
                <StatsCard
                    Title="This Month"
                    Value="@monthlyAttendance.ToString()"
                    SubLabel="Total days"
                    Color="primary" />
            </div>
            <div class="col-md-3">
                <StatsCard
                    Title="On Time"
                    Value="@onTimeCount.ToString()"
                    SubLabel="@($"{onTimePercentage}% punctual")"
                    Color="success" />
            </div>
            <div class="col-md-3">
                <StatsCard
                    Title="Total Hours"
                    Value="@totalHours.ToString("F1")"
                    SubLabel="This month"
                    Color="info" />
            </div>
            <div class="col-md-3">
                <StatsCard
                    Title="Estimated Wage"
                    Value="@($"${totalWage:F2}")"
                    SubLabel="This month"
                    Color="success" />
            </div>
        </div>

        @* Recent Attendance & Quick Actions *@
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><span class="bi bi-clock-history me-2"></span>Recent Attendance</h5>
                    </div>
                    <div class="card-body">
                        @if (recentAttendances == null || !recentAttendances.Any())
                        {
                            <p class="text-muted mb-0">No attendance records found</p>
                        }
                        else
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var attendance in recentAttendances.Take(5))
                                {
                                    <div class="list-group-item px-0">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>@attendance.Date.ToString("MMM dd, yyyy")</strong>
                                                <br />
                                                <small class="text-muted">
                                                    @attendance.ShiftType?.Name â€¢ @attendance.CheckIn.ToString("h:mm tt") - @(attendance.CheckOut?.ToString("h:mm tt") ?? "Ongoing")
                                                </small>
                                            </div>
                                            <div>
                                                @if (attendance.CheckOut == null)
                                                {
                                                    <StatusBadge Status="Pending" />
                                                }
                                                else if (attendance.IsLate)
                                                {
                                                    <StatusBadge Status="Late" />
                                                }
                                                else
                                                {
                                                    <StatusBadge Status="On Time" />
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><span class="bi bi-lightning me-2"></span>Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-3">
                            <a href="/attendance/check-in-out" class="btn btn-outline-primary btn-lg">
                                <span class="bi bi-calendar-check me-2"></span>
                                Check In/Out
                            </a>
                            <a href="/attendance/history" class="btn btn-outline-success btn-lg">
                                <span class="bi bi-clock-history me-2"></span>
                                View Attendance History
                            </a>
                            <a href="/employee/profile" class="btn btn-outline-info btn-lg">
                                <span class="bi bi-person me-2"></span>
                                My Profile
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private string? errorMessage;
    private string currentUserName = "";
    private int currentUserId = 0;

    // Stats
    private int monthlyAttendance = 0;
    private int onTimeCount = 0;
    private decimal totalHours = 0;
    private decimal totalWage = 0;
    private int onTimePercentage => monthlyAttendance > 0 ? (int)((double)onTimeCount / monthlyAttendance * 100) : 0;

    // Data
    private AttendanceDto? todayAttendance;
    private List<AttendanceDto>? recentAttendances;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            // Get current user info
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var userIdClaim = user.FindFirst("userId")?.Value;
            var fullNameClaim = user.FindFirst("fullName")?.Value;

            if (string.IsNullOrEmpty(userIdClaim) || !int.TryParse(userIdClaim, out currentUserId))
            {
                errorMessage = "Unable to identify current user. Please log in again.";
                return;
            }

            currentUserName = fullNameClaim ?? "User";

            // Load user's attendance records
            var attendancesQuery = $@"
                query GetAttendancesByUser {{
                    attendancesByUser(userId: {currentUserId}) {{
                        attendanceId
                        userId
                        shiftTypeId
                        date
                        checkIn
                        checkOut
                        isLate
                        shiftType {{
                            shiftTypeId
                            name
                            startTime
                            endTime
                            wagePerHour
                        }}
                    }}
                }}
            ";

            var attendancesResponse = await GraphQLClient.QueryAsync<GetAttendancesByUserResponse>(attendancesQuery);
            if (attendancesResponse.Errors == null || !attendancesResponse.Errors.Any())
            {
                var allAttendances = attendancesResponse.Data?.AttendancesByUser ?? new List<AttendanceDto>();

                // Today's attendance
                todayAttendance = allAttendances.FirstOrDefault(a => a.Date.Date == DateTime.Today);

                // This month's stats
                var monthStart = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
                var monthRecords = allAttendances.Where(a => a.Date >= monthStart && a.Date <= DateTime.Today).ToList();
                monthlyAttendance = monthRecords.Count;
                onTimeCount = monthRecords.Count(a => !a.IsLate);

                var completedMonthRecords = monthRecords.Where(a => a.CheckOut != null).ToList();
                if (completedMonthRecords.Any())
                {
                    totalHours = (decimal)completedMonthRecords.Sum(a => (a.CheckOut!.Value - a.CheckIn).TotalHours);
                    totalWage = completedMonthRecords.Sum(a =>
                    {
                        var duration = (a.CheckOut!.Value - a.CheckIn).TotalHours;
                        return (decimal)duration * (a.ShiftType?.WagePerHour ?? 0);
                    });
                }

                // Recent attendances (last 10, sorted by date)
                recentAttendances = allAttendances
                    .OrderByDescending(a => a.Date)
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load dashboard data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetWorkingDuration()
    {
        if (todayAttendance == null) return "0h 0m";

        if (todayAttendance.CheckOut != null)
        {
            var duration = todayAttendance.CheckOut.Value - todayAttendance.CheckIn;
            return $"{(int)duration.TotalHours}h {duration.Minutes}m";
        }
        else
        {
            var duration = DateTime.Now - todayAttendance.CheckIn;
            return $"{(int)duration.TotalHours}h {duration.Minutes}m";
        }
    }

    private string FormatTime(TimeSpan? time)
    {
        if (time == null) return "N/A";
        return DateTime.Today.Add(time.Value).ToString("h:mm tt");
    }

    // DTOs
    public class ShiftTypeDto
    {
        public int ShiftTypeId { get; set; }
        public string Name { get; set; } = string.Empty;
        public TimeSpan StartTime { get; set; }
        public TimeSpan EndTime { get; set; }
        public decimal WagePerHour { get; set; }
    }

    public class AttendanceDto
    {
        public int AttendanceId { get; set; }
        public int UserId { get; set; }
        public int ShiftTypeId { get; set; }
        public DateTime Date { get; set; }
        public DateTime CheckIn { get; set; }
        public DateTime? CheckOut { get; set; }
        public bool IsLate { get; set; }
        public ShiftTypeDto? ShiftType { get; set; }
    }

    // GraphQL Response Types
    private class GetAttendancesByUserResponse
    {
        public List<AttendanceDto>? AttendancesByUser { get; set; }
    }
}
