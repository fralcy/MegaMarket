@page "/admin/dashboard"
@attribute [Authorize(Roles = "Admin")]
@inject Services.Dashboard.DashboardApiClient DashboardApiClient
@using MegaMarket.BlazorUI.Models.Dashboard
@using ApexCharts

<div class="container-fluid mt-4">
    @* Header *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-gradient mb-1">Admin Dashboard</h2>
            <p class="text-muted mb-0">Comprehensive business analytics and insights</p>
        </div>
        <DateRangeSelector SelectedRange="@selectedRange" OnRangeChanged="@HandleRangeChanged" />
    </div>

    @* Error Message *@
    @if (!string.IsNullOrEmpty(globalErrorMessage))
    {
        <ErrorAlert ErrorMessage="@globalErrorMessage" OnDismiss="@(() => globalErrorMessage = null)" />
    }

    @* ==================== SALES ANALYTICS ==================== *@
    <div class="mb-5">
        <h4 class="mb-3">
            <span class="bi bi-graph-up me-2"></span>Sales & Revenue Analytics
        </h4>

        <DashboardSection IsLoading="@isSalesLoading"
                          ErrorMessage="@salesErrorMessage"
                          ShowRetryButton="true"
                          OnRetry="@LoadSalesDashboard">
            @if (salesData != null)
            {
                @* Revenue Stats Row *@
                <div class="row mb-4">
                    <div class="col-md-4">
                        <StatsCard
                            Title="Total Revenue"
                            Value="@($"${salesData.TotalRevenue:N2}")"
                            SubLabel="@GetDateRangeLabel()"
                            Color="success" />
                    </div>
                    <div class="col-md-4">
                        <StatsCard
                            Title="Total Invoices"
                            Value="@salesData.TotalInvoices.ToString("N0")"
                            SubLabel="Completed orders"
                            Color="primary" />
                    </div>
                    <div class="col-md-4">
                        <StatsCard
                            Title="Average Order Value"
                            Value="@($"${salesData.AverageOrderValue:N2}")"
                            SubLabel="Per invoice"
                            Color="info" />
                    </div>
                </div>

                @* Charts Row *@
                <div class="row mb-4">
                    @* Revenue Trend Chart *@
                    <div class="col-lg-8 mb-3">
                        <ChartCard Title="Revenue Trend" Subtitle="@GetDateRangeLabel()" Height="350px">
                            @if (salesData.RevenueTrend.Any())
                            {
                                <ApexChart TItem="RevenueTrendDto"
                                           Title="Revenue Over Time"
                                           Options="@revenueTrendOptions">
                                    <ApexPointSeries TItem="RevenueTrendDto"
                                                     Items="@salesData.RevenueTrend"
                                                     Name="Revenue"
                                                     SeriesType="SeriesType.Area"
                                                     XValue="@(e => e.Date)"
                                                     YAggregate="@(e => (decimal?)e.Sum(f => f.Revenue))"
                                                     OrderBy="e => e.X" />
                                </ApexChart>
                            }
                            else
                            {
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <p class="text-muted">No revenue data available</p>
                                </div>
                            }
                        </ChartCard>
                    </div>

                    @* Payment Method Breakdown *@
                    <div class="col-lg-4 mb-3">
                        <ChartCard Title="Payment Methods" Subtitle="Revenue distribution" Height="350px">
                            @if (salesData.RevenueByPaymentMethod.Any())
                            {
                                <ApexChart TItem="RevenueByPaymentMethodDto"
                                           Options="@paymentMethodOptions">
                                    <ApexPointSeries TItem="RevenueByPaymentMethodDto"
                                                     Items="@salesData.RevenueByPaymentMethod"
                                                     Name="Revenue"
                                                     SeriesType="SeriesType.Pie"
                                                     XValue="@(e => e.PaymentMethod)"
                                                     YAggregate="@(e => (decimal?)e.Sum(f => f.Revenue))" />
                                </ApexChart>
                            }
                            else
                            {
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <p class="text-muted">No payment data available</p>
                                </div>
                            }
                        </ChartCard>
                    </div>
                </div>

                @* Top Selling Products *@
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <span class="bi bi-star me-2"></span>Top Selling Products
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (salesData.TopSellingProducts.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th class="text-end">Quantity Sold</th>
                                            <th class="text-end">Revenue</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var product in salesData.TopSellingProducts.Take(10))
                                        {
                                            <tr>
                                                <td>
                                                    <strong>@product.ProductName</strong>
                                                    <br />
                                                    <small class="text-muted">ID: @product.ProductId</small>
                                                </td>
                                                <td class="text-end">
                                                    <span class="badge bg-primary">@product.QuantitySold.ToString("N0")</span>
                                                </td>
                                                <td class="text-end">
                                                    <strong class="text-success">$@product.Revenue.ToString("N2")</strong>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted mb-0">No sales data available</p>
                        }
                    </div>
                </div>
            }
        </DashboardSection>
    </div>

    @* ==================== INVENTORY ANALYTICS ==================== *@
    <div class="mb-5">
        <h4 class="mb-3">
            <span class="bi bi-box-seam me-2"></span>Inventory & Stock Analytics
        </h4>

        <DashboardSection IsLoading="@isInventoryLoading"
                          ErrorMessage="@inventoryErrorMessage"
                          ShowRetryButton="true"
                          OnRetry="@LoadInventoryDashboard">
            @if (inventoryData != null)
            {
                @* Inventory Stats Row *@
                <div class="row mb-4">
                    <div class="col-md-3">
                        <StatsCard
                            Title="Total Products"
                            Value="@inventoryData.TotalProducts.ToString("N0")"
                            SubLabel="In catalog"
                            Color="primary" />
                    </div>
                    <div class="col-md-3">
                        <StatsCard
                            Title="Categories"
                            Value="@inventoryData.TotalCategories.ToString("N0")"
                            SubLabel="Product categories"
                            Color="info" />
                    </div>
                    <div class="col-md-3">
                        <StatsCard
                            Title="Total Stock Value"
                            Value="@($"${inventoryData.TotalStockValue:N2}")"
                            SubLabel="Inventory value"
                            Color="success" />
                    </div>
                    <div class="col-md-3">
                        <StatsCard
                            Title="Low Stock Items"
                            Value="@inventoryData.LowStockCount.ToString("N0")"
                            SubLabel="@($"{inventoryData.OutOfStockCount} out of stock")"
                            Color="warning" />
                    </div>
                </div>

                @* Stock by Category Chart *@
                <div class="row mb-4">
                    <div class="col-12">
                        <ChartCard Title="Stock by Category" Subtitle="Inventory distribution" Height="300px">
                            @if (inventoryData.StockByCategory.Any())
                            {
                                <ApexChart TItem="CategoryStockDto"
                                           Options="@categoryStockOptions">
                                    <ApexPointSeries TItem="CategoryStockDto"
                                                     Items="@inventoryData.StockByCategory"
                                                     Name="Quantity"
                                                     SeriesType="SeriesType.Bar"
                                                     XValue="@(e => e.CategoryName)"
                                                     YAggregate="@(e => e.Sum(f => f.TotalQuantity))"
                                                     OrderByDescending="e => e.Y" />
                                </ApexChart>
                            }
                            else
                            {
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <p class="text-muted">No category data available</p>
                                </div>
                            }
                        </ChartCard>
                    </div>
                </div>

                @* Alerts Row *@
                <div class="row">
                    @* Low Stock Products *@
                    <div class="col-lg-6 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <span class="bi bi-exclamation-triangle me-2"></span>Low Stock Alert
                                </h5>
                            </div>
                            <div class="card-body">
                                @if (inventoryData.LowStockProducts.Any())
                                {
                                    <div class="list-group list-group-flush">
                                        @foreach (var product in inventoryData.LowStockProducts.Take(5))
                                        {
                                            <div class="list-group-item px-0">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <strong>@product.ProductName</strong>
                                                        <br />
                                                        <small class="text-muted">@product.CategoryName</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="badge bg-danger">@product.CurrentStock / @product.MinimumStock</span>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                    @if (inventoryData.LowStockProducts.Count > 5)
                                    {
                                        <div class="text-center mt-2">
                                            <small class="text-muted">And @(inventoryData.LowStockProducts.Count - 5) more...</small>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted mb-0">All products are well stocked!</p>
                                }
                            </div>
                        </div>
                    </div>

                    @* Expiring Products *@
                    <div class="col-lg-6 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0">
                                    <span class="bi bi-calendar-x me-2"></span>Expiring Soon
                                </h5>
                            </div>
                            <div class="card-body">
                                @if (inventoryData.ExpiringProducts.Any())
                                {
                                    <div class="list-group list-group-flush">
                                        @foreach (var product in inventoryData.ExpiringProducts.Take(5))
                                        {
                                            <div class="list-group-item px-0">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <strong>@product.ProductName</strong>
                                                        <br />
                                                        <small class="text-muted">Qty: @product.Quantity</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="badge bg-danger">@product.DaysUntilExpiry days</div>
                                                        <br />
                                                        <small class="text-muted">@product.ExpiryDate.ToString("MMM dd")</small>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                    @if (inventoryData.ExpiringProducts.Count > 5)
                                    {
                                        <div class="text-center mt-2">
                                            <small class="text-muted">And @(inventoryData.ExpiringProducts.Count - 5) more...</small>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted mb-0">No products expiring soon</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </DashboardSection>
    </div>

    @* ==================== CUSTOMER ANALYTICS ==================== *@
    <div class="mb-5">
        <h4 class="mb-3">
            <span class="bi bi-people me-2"></span>Customer & Loyalty Analytics
        </h4>

        <DashboardSection IsLoading="@isCustomerLoading"
                          ErrorMessage="@customerErrorMessage"
                          ShowRetryButton="true"
                          OnRetry="@LoadCustomerDashboard">
            @if (customerData != null)
            {
                @* Customer Stats Row *@
                <div class="row mb-4">
                    <div class="col-md-3">
                        <StatsCard
                            Title="Total Customers"
                            Value="@customerData.TotalCustomers.ToString("N0")"
                            SubLabel="Registered customers"
                            Color="primary" />
                    </div>
                    <div class="col-md-3">
                        <StatsCard
                            Title="New Customers"
                            Value="@customerData.NewCustomers.ToString("N0")"
                            SubLabel="@GetDateRangeLabel()"
                            Color="success" />
                    </div>
                    <div class="col-md-3">
                        <StatsCard
                            Title="Average Spending"
                            Value="@($"${customerData.AverageSpending:N2}")"
                            SubLabel="Per customer"
                            Color="info" />
                    </div>
                    <div class="col-md-3">
                        <StatsCard
                            Title="Active Loyalty Points"
                            Value="@(customerData.LoyaltyPointsSummary?.ActivePoints.ToString("N0") ?? "N/A")"
                            SubLabel="Total points in system"
                            Color="warning" />
                    </div>
                </div>

                @* Charts Row *@
                <div class="row mb-4">
                    @* Customer Rank Distribution *@
                    <div class="col-lg-6 mb-3">
                        <ChartCard Title="Customer Rank Distribution" Subtitle="Customer segmentation" Height="350px">
                            @if (customerData.CustomerRankDistribution.Any())
                            {
                                <ApexChart TItem="CustomerRankDistributionDto"
                                           Options="@customerRankOptions">
                                    <ApexPointSeries TItem="CustomerRankDistributionDto"
                                                     Items="@customerData.CustomerRankDistribution"
                                                     Name="Customers"
                                                     SeriesType="SeriesType.Donut"
                                                     XValue="@(e => e.Rank)"
                                                     YAggregate="@(e => e.Sum(f => f.Count))" />
                                </ApexChart>
                            }
                            else
                            {
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <p class="text-muted">No customer rank data available</p>
                                </div>
                            }
                        </ChartCard>
                    </div>

                    @* Loyalty Points Summary *@
                    <div class="col-lg-6 mb-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <span class="bi bi-gift me-2"></span>Loyalty Points Summary
                                </h5>
                            </div>
                            <div class="card-body">
                                @if (customerData.LoyaltyPointsSummary != null)
                                {
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="mb-3">
                                                <h3 class="text-primary mb-1">@customerData.LoyaltyPointsSummary.TotalPointsIssued.ToString("N0")</h3>
                                                <small class="text-muted">Total Issued</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="mb-3">
                                                <h3 class="text-danger mb-1">@customerData.LoyaltyPointsSummary.TotalPointsRedeemed.ToString("N0")</h3>
                                                <small class="text-muted">Total Redeemed</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="mb-3">
                                                <h3 class="text-success mb-1">@customerData.LoyaltyPointsSummary.ActivePoints.ToString("N0")</h3>
                                                <small class="text-muted">Active Points</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-success" role="progressbar"
                                             style="width: @(GetPercentage(customerData.LoyaltyPointsSummary.ActivePoints, customerData.LoyaltyPointsSummary.TotalPointsIssued))%">
                                            Active
                                        </div>
                                        <div class="progress-bar bg-danger" role="progressbar"
                                             style="width: @(GetPercentage(customerData.LoyaltyPointsSummary.TotalPointsRedeemed, customerData.LoyaltyPointsSummary.TotalPointsIssued))%">
                                            Redeemed
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted mb-0">No loyalty points data available</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                @* Top Customers *@
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <span class="bi bi-star me-2"></span>Top Customers by Spending
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (customerData.TopCustomers.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th>Customer</th>
                                            <th>Phone</th>
                                            <th class="text-end">Invoices</th>
                                            <th class="text-end">Total Spending</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var customer in customerData.TopCustomers.Take(10))
                                        {
                                            <tr>
                                                <td>
                                                    <strong>@customer.CustomerName</strong>
                                                    <br />
                                                    <small class="text-muted">ID: @customer.CustomerId</small>
                                                </td>
                                                <td>@customer.Phone</td>
                                                <td class="text-end">
                                                    <span class="badge bg-primary">@customer.InvoiceCount</span>
                                                </td>
                                                <td class="text-end">
                                                    <strong class="text-success">$@customer.TotalSpending.ToString("N2")</strong>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted mb-0">No customer data available</p>
                        }
                    </div>
                </div>
            }
        </DashboardSection>
    </div>

    @* ==================== EMPLOYEE ANALYTICS ==================== *@
    <div class="mb-5">
        <h4 class="mb-3">
            <span class="bi bi-person-badge me-2"></span>Employee & Attendance Analytics
        </h4>

        <DashboardSection IsLoading="@isEmployeeLoading"
                          ErrorMessage="@employeeErrorMessage"
                          ShowRetryButton="true"
                          OnRetry="@LoadEmployeeDashboard">
            @if (employeeData != null)
            {
                @* Employee Stats Row *@
                <div class="row mb-4">
                    @if (employeeData.TotalEmployees.HasValue)
                    {
                        <div class="col-md-3">
                            <StatsCard
                                Title="Total Employees"
                                Value="@employeeData.TotalEmployees.Value.ToString("N0")"
                                SubLabel="Active staff members"
                                Color="primary" />
                        </div>
                    }
                    <div class="col-md-3">
                        <StatsCard
                            Title="Total Attendances"
                            Value="@employeeData.TotalAttendances.ToString("N0")"
                            SubLabel="@GetDateRangeLabel()"
                            Color="info" />
                    </div>
                    <div class="col-md-3">
                        <StatsCard
                            Title="On-Time Rate"
                            Value="@($"{employeeData.OnTimePercentage:F1}%")"
                            SubLabel="Attendance punctuality"
                            Color="success" />
                    </div>
                    @if (employeeData.TotalWages.HasValue)
                    {
                        <div class="col-md-3">
                            <StatsCard
                                Title="Total Wages"
                                Value="@($"${employeeData.TotalWages.Value:N2}")"
                                SubLabel="@GetDateRangeLabel()"
                                Color="warning" />
                        </div>
                    }
                </div>

                @* Charts Row *@
                <div class="row mb-4">
                    @* Attendance by Shift - Count *@
                    <div class="col-lg-6 mb-3">
                        <ChartCard Title="Attendance by Shift" Subtitle="Attendance count distribution" Height="350px">
                            @if (employeeData.AttendanceByShift.Any())
                            {
                                <ApexChart TItem="AttendanceByShiftDto"
                                           Options="@attendanceByShiftOptions">
                                    <ApexPointSeries TItem="AttendanceByShiftDto"
                                                     Items="@employeeData.AttendanceByShift"
                                                     Name="Attendances"
                                                     SeriesType="SeriesType.Donut"
                                                     XValue="@(e => e.ShiftName)"
                                                     YAggregate="@(e => e.Sum(f => f.AttendanceCount))" />
                                </ApexChart>
                            }
                            else
                            {
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <p class="text-muted">No shift attendance data available</p>
                                </div>
                            }
                        </ChartCard>
                    </div>

                    @* Total Hours by Shift *@
                    <div class="col-lg-6 mb-3">
                        <ChartCard Title="Work Hours by Shift" Subtitle="Total hours worked" Height="350px">
                            @if (employeeData.AttendanceByShift.Any())
                            {
                                <ApexChart TItem="AttendanceByShiftDto"
                                           Options="@hoursBarOptions">
                                    <ApexPointSeries TItem="AttendanceByShiftDto"
                                                     Items="@employeeData.AttendanceByShift"
                                                     Name="Hours"
                                                     SeriesType="SeriesType.Bar"
                                                     XValue="@(e => e.ShiftName)"
                                                     YAggregate="@(e => (decimal)e.Sum(f => f.TotalHoursWorked))"
                                                     OrderByDescending="e => e.Y" />
                                </ApexChart>
                            }
                            else
                            {
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <p class="text-muted">No hours data available</p>
                                </div>
                            }
                        </ChartCard>
                    </div>
                </div>

                @* Attendance Details Table *@
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <span class="bi bi-clipboard-data me-2"></span>Attendance by Shift Details
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (employeeData.AttendanceByShift.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th>Shift</th>
                                            <th class="text-end">Total Attendances</th>
                                            <th class="text-end">On Time</th>
                                            <th class="text-end">Late</th>
                                            <th class="text-end">Total Hours</th>
                                            <th class="text-end">Punctuality Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var shift in employeeData.AttendanceByShift)
                                        {
                                            var punctualityRate = shift.AttendanceCount > 0 ? (double)shift.OnTimeCount / shift.AttendanceCount * 100 : 0;
                                            <tr>
                                                <td>
                                                    <strong>@shift.ShiftName</strong>
                                                </td>
                                                <td class="text-end">
                                                    <span class="badge bg-primary">@shift.AttendanceCount</span>
                                                </td>
                                                <td class="text-end">
                                                    <span class="badge bg-success">@shift.OnTimeCount</span>
                                                </td>
                                                <td class="text-end">
                                                    <span class="badge bg-warning">@shift.LateCount</span>
                                                </td>
                                                <td class="text-end">
                                                    <strong>@shift.TotalHoursWorked.ToString("F1")h</strong>
                                                </td>
                                                <td class="text-end">
                                                    <span class="badge @(punctualityRate >= 90 ? "bg-success" : punctualityRate >= 75 ? "bg-warning" : "bg-danger")">
                                                        @punctualityRate.ToString("F0")%
                                                    </span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted mb-0">No attendance data available</p>
                        }
                    </div>
                </div>
            }
        </DashboardSection>
    </div>
</div>

@code {
    // State
    private DateRangeEnum selectedRange = DateRangeEnum.Today;
    private string? globalErrorMessage;
    private bool _isLoading = false; // Prevent concurrent loads

    // Sales Data
    private bool isSalesLoading = true;
    private string? salesErrorMessage;
    private SalesDashboardDto? salesData;

    // Inventory Data
    private bool isInventoryLoading = true;
    private string? inventoryErrorMessage;
    private InventoryDashboardDto? inventoryData;

    // Customer Data
    private bool isCustomerLoading = true;
    private string? customerErrorMessage;
    private CustomerDashboardDto? customerData;

    // Employee Data
    private bool isEmployeeLoading = true;
    private string? employeeErrorMessage;
    private EmployeeDashboardDto? employeeData;

    // Chart Options
    private ApexChartOptions<RevenueTrendDto> revenueTrendOptions = new()
    {
        Chart = new Chart
        {
            Toolbar = new Toolbar { Show = false },
            Zoom = new Zoom { Enabled = false }
        },
        Stroke = new Stroke { Curve = Curve.Smooth, Width = 2 },
        DataLabels = new DataLabels { Enabled = false },
        Colors = new List<string> { "#28a745" },
        Fill = new Fill
        {
            Type = new List<FillType> { FillType.Gradient },
            Gradient = new FillGradient
            {
                ShadeIntensity = 1,
                OpacityFrom = 0.7,
                OpacityTo = 0.3
            }
        }
    };

    private ApexChartOptions<RevenueByPaymentMethodDto> paymentMethodOptions = new()
    {
        Chart = new Chart { Toolbar = new Toolbar { Show = false } },
        Legend = new Legend { Position = LegendPosition.Bottom },
        Colors = new List<string> { "#007bff", "#28a745", "#ffc107", "#dc3545" }
    };

    private ApexChartOptions<CategoryStockDto> categoryStockOptions = new()
    {
        Chart = new Chart
        {
            Toolbar = new Toolbar { Show = false },
            Zoom = new Zoom { Enabled = false }
        },
        PlotOptions = new PlotOptions
        {
            Bar = new PlotOptionsBar
            {
                Horizontal = true,
                Distributed = true
            }
        },
        DataLabels = new DataLabels { Enabled = false },
        Legend = new Legend { Show = false },
        Colors = new List<string> { "#007bff", "#6610f2", "#6f42c1", "#e83e8c", "#dc3545", "#fd7e14", "#ffc107", "#28a745" }
    };

    private ApexChartOptions<CustomerRankDistributionDto> customerRankOptions = new()
    {
        Chart = new Chart { Toolbar = new Toolbar { Show = false } },
        Legend = new Legend { Position = LegendPosition.Bottom },
        Colors = new List<string> { "#ffc107", "#28a745", "#007bff", "#dc3545" }
    };

    private ApexChartOptions<AttendanceByShiftDto> attendanceByShiftOptions = new()
    {
        Chart = new Chart { Toolbar = new Toolbar { Show = false } },
        Legend = new Legend { Position = LegendPosition.Bottom },
        Colors = new List<string> { "#007bff", "#28a745", "#ffc107", "#dc3545", "#6610f2" }
    };

    private ApexChartOptions<AttendanceByShiftDto> hoursBarOptions = new()
    {
        Chart = new Chart
        {
            Toolbar = new Toolbar { Show = false },
            Zoom = new Zoom { Enabled = false }
        },
        PlotOptions = new PlotOptions
        {
            Bar = new PlotOptionsBar { Horizontal = true }
        },
        DataLabels = new DataLabels { Enabled = false },
        Colors = new List<string> { "#007bff" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadAllDashboards();
    }

    private async Task LoadAllDashboards()
    {
        if (_isLoading) return; // Prevent concurrent loads

        _isLoading = true;
        try
        {
            await Task.WhenAll(
                LoadSalesDashboard(),
                LoadInventoryDashboard(),
                LoadCustomerDashboard(),
                LoadEmployeeDashboard()
            );
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadSalesDashboard()
    {
        try
        {
            isSalesLoading = true;
            salesErrorMessage = null;

            var result = await DashboardApiClient.GetSalesDashboardAsync(selectedRange);

            if (result != null)
            {
                salesData = result;
            }
            else
            {
                salesErrorMessage = "No sales data returned from server";
            }
        }
        catch (Exception ex)
        {
            salesErrorMessage = $"Failed to load sales data: {ex.Message}";
        }
        finally
        {
            isSalesLoading = false;
        }
    }

    private async Task LoadInventoryDashboard()
    {
        try
        {
            isInventoryLoading = true;
            inventoryErrorMessage = null;

            var result = await DashboardApiClient.GetInventoryDashboardAsync();

            if (result != null)
            {
                inventoryData = result;
            }
            else
            {
                inventoryErrorMessage = "No inventory data returned from server";
            }
        }
        catch (Exception ex)
        {
            inventoryErrorMessage = $"Failed to load inventory data: {ex.Message}";
        }
        finally
        {
            isInventoryLoading = false;
        }
    }

    private async Task LoadCustomerDashboard()
    {
        try
        {
            isCustomerLoading = true;
            customerErrorMessage = null;

            var result = await DashboardApiClient.GetCustomerDashboardAsync(selectedRange);

            if (result != null)
            {
                customerData = result;
            }
            else
            {
                customerErrorMessage = "No customer data returned from server";
            }
        }
        catch (Exception ex)
        {
            customerErrorMessage = $"Failed to load customer data: {ex.Message}";
        }
        finally
        {
            isCustomerLoading = false;
        }
    }

    private async Task LoadEmployeeDashboard()
    {
        try
        {
            isEmployeeLoading = true;
            employeeErrorMessage = null;

            var result = await DashboardApiClient.GetEmployeeDashboardAsync(selectedRange);

            if (result != null)
            {
                employeeData = result;
            }
            else
            {
                employeeErrorMessage = "No employee data returned from server";
            }
        }
        catch (Exception ex)
        {
            employeeErrorMessage = $"Failed to load employee data: {ex.Message}";
        }
        finally
        {
            isEmployeeLoading = false;
        }
    }

    private async Task HandleRangeChanged(DateRangeEnum newRange)
    {
        selectedRange = newRange;
        await LoadAllDashboards();
    }

    private string GetDateRangeLabel()
    {
        return selectedRange switch
        {
            DateRangeEnum.Today => "Today",
            DateRangeEnum.ThisWeek => "This Week",
            DateRangeEnum.ThisMonth => "This Month",
            DateRangeEnum.ThisYear => "This Year",
            _ => "Unknown"
        };
    }

    private double GetPercentage(int value, int total)
    {
        return total > 0 ? (double)value / total * 100 : 0;
    }
}
