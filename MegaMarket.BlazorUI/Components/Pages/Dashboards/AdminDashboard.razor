@page "/admin/dashboard"
@attribute [Authorize(Roles = "Admin")]
@inject Services.GraphQL.GraphQLClient GraphQLClient

<div class="container-fluid mt-4">
    @* Header *@
    <div class="mb-4">
        <h2 class="text-gradient mb-1">Admin Dashboard</h2>
        <p class="text-muted">System overview and key metrics</p>
    </div>

    @* Error Message *@
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <ErrorAlert ErrorMessage="@errorMessage" OnDismiss="@(() => errorMessage = null)" />
    }

    @* Loading State *@
    @if (isLoading)
    {
        <LoadingSpinner Message="Loading dashboard data..." />
    }
    else
    {
        @* Main Stats Row *@
        <div class="row mb-4">
            <div class="col-md-3">
                <StatsCard
                    Title="Total Employees"
                    Value="@totalEmployees.ToString()"
                    SubLabel="Active users"
                    Color="primary" />
            </div>
            <div class="col-md-3">
                <StatsCard
                    Title="Shift Types"
                    Value="@totalShiftTypes.ToString()"
                    SubLabel="Configured shifts"
                    Color="info" />
            </div>
            <div class="col-md-3">
                <StatsCard
                    Title="Today's Attendance"
                    Value="@todayAttendance.ToString()"
                    SubLabel="Check-ins today"
                    Color="success" />
            </div>
            <div class="col-md-3">
                <StatsCard
                    Title="Pending Checkouts"
                    Value="@pendingCheckouts.ToString()"
                    SubLabel="Still working"
                    Color="warning" />
            </div>
        </div>

        @* Secondary Stats Row *@
        <div class="row mb-4">
            <div class="col-md-3">
                <StatsCard
                    Title="On Time Today"
                    Value="@onTimeToday.ToString()"
                    SubLabel="@($"{onTimePercentage}% punctual")"
                    Color="success" />
            </div>
            <div class="col-md-3">
                <StatsCard
                    Title="Late Today"
                    Value="@lateToday.ToString()"
                    SubLabel="Late arrivals"
                    Color="danger" />
            </div>
            <div class="col-md-3">
                <StatsCard
                    Title="This Month"
                    Value="@monthlyAttendance.ToString()"
                    SubLabel="Total records"
                    Color="info" />
            </div>
            <div class="col-md-3">
                <StatsCard
                    Title="Avg Hours/Day"
                    Value="@avgHoursPerDay.ToString("F1")"
                    SubLabel="This month"
                    Color="primary" />
            </div>
        </div>

        @* Recent Activity *@
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><span class="bi bi-clock-history me-2"></span>Recent Check-Ins</h5>
                    </div>
                    <div class="card-body">
                        @if (recentCheckIns == null || !recentCheckIns.Any())
                        {
                            <p class="text-muted mb-0">No recent check-ins</p>
                        }
                        else
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var attendance in recentCheckIns.Take(5))
                                {
                                    <div class="list-group-item px-0">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>@attendance.User?.FullName</strong>
                                                <br />
                                                <small class="text-muted">
                                                    @attendance.ShiftType?.Name â€¢ @attendance.CheckIn.ToString("h:mm tt")
                                                </small>
                                            </div>
                                            <div>
                                                @if (attendance.IsLate)
                                                {
                                                    <StatusBadge Status="Late" />
                                                }
                                                else
                                                {
                                                    <StatusBadge Status="On Time" />
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><span class="bi bi-people me-2"></span>Active Employees</h5>
                    </div>
                    <div class="card-body">
                        @if (activeEmployees == null || !activeEmployees.Any())
                        {
                            <p class="text-muted mb-0">No employees currently working</p>
                        }
                        else
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var attendance in activeEmployees.Take(5))
                                {
                                    <div class="list-group-item px-0">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>@attendance.User?.FullName</strong>
                                                <br />
                                                <small class="text-muted">
                                                    @attendance.ShiftType?.Name
                                                </small>
                                            </div>
                                            <div>
                                                <span class="badge bg-success">Working @GetWorkingDuration(attendance)</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        @* Quick Actions *@
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><span class="bi bi-lightning me-2"></span>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <a href="/admin/employees" class="btn btn-outline-primary w-100">
                            <span class="bi bi-people me-2"></span>
                            Manage Employees
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/admin/shift-types" class="btn btn-outline-info w-100">
                            <span class="bi bi-clock me-2"></span>
                            Manage Shifts
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/attendance/history" class="btn btn-outline-success w-100">
                            <span class="bi bi-clock-history me-2"></span>
                            View Attendance
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/attendance/check-in-out" class="btn btn-outline-warning w-100">
                            <span class="bi bi-calendar-check me-2"></span>
                            Check In/Out
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private string? errorMessage;

    // Stats
    private int totalEmployees = 0;
    private int totalShiftTypes = 0;
    private int todayAttendance = 0;
    private int pendingCheckouts = 0;
    private int onTimeToday = 0;
    private int lateToday = 0;
    private int monthlyAttendance = 0;
    private decimal avgHoursPerDay = 0;
    private int onTimePercentage => todayAttendance > 0 ? (int)((double)onTimeToday / todayAttendance * 100) : 0;

    // Lists
    private List<AttendanceDto>? recentCheckIns;
    private List<AttendanceDto>? activeEmployees;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            // Load users
            var usersQuery = @"
                query GetUsers {
                    users {
                        userId
                        fullName
                        role
                    }
                }
            ";

            var usersResponse = await GraphQLClient.QueryAsync<GetUsersResponse>(usersQuery);
            if (usersResponse.Errors == null || !usersResponse.Errors.Any())
            {
                totalEmployees = usersResponse.Data?.Users?.Count ?? 0;
            }

            // Load shift types
            var shiftTypesQuery = @"
                query GetShiftTypes {
                    shiftTypes {
                        shiftTypeId
                        name
                    }
                }
            ";

            var shiftTypesResponse = await GraphQLClient.QueryAsync<GetShiftTypesResponse>(shiftTypesQuery);
            if (shiftTypesResponse.Errors == null || !shiftTypesResponse.Errors.Any())
            {
                totalShiftTypes = shiftTypesResponse.Data?.ShiftTypes?.Count ?? 0;
            }

            // Load all attendance records
            var attendancesQuery = @"
                query GetAttendances {
                    attendances {
                        attendanceId
                        userId
                        shiftTypeId
                        date
                        checkIn
                        checkOut
                        isLate
                        user {
                            userId
                            fullName
                            username
                        }
                        shiftType {
                            shiftTypeId
                            name
                            startTime
                            endTime
                        }
                    }
                }
            ";

            var attendancesResponse = await GraphQLClient.QueryAsync<GetAttendancesResponse>(attendancesQuery);
            if (attendancesResponse.Errors == null || !attendancesResponse.Errors.Any())
            {
                var allAttendances = attendancesResponse.Data?.Attendances ?? new List<AttendanceDto>();

                // Today's stats
                var today = DateTime.Today;
                var todayRecords = allAttendances.Where(a => a.Date.Date == today).ToList();
                todayAttendance = todayRecords.Count;
                onTimeToday = todayRecords.Count(a => !a.IsLate);
                lateToday = todayRecords.Count(a => a.IsLate);
                pendingCheckouts = todayRecords.Count(a => a.CheckOut == null);

                // This month's stats
                var monthStart = new DateTime(today.Year, today.Month, 1);
                var monthRecords = allAttendances.Where(a => a.Date >= monthStart && a.Date <= today).ToList();
                monthlyAttendance = monthRecords.Count;

                var completedMonthRecords = monthRecords.Where(a => a.CheckOut != null).ToList();
                if (completedMonthRecords.Any())
                {
                    var totalHours = completedMonthRecords.Sum(a => (a.CheckOut!.Value - a.CheckIn).TotalHours);
                    var daysInMonth = (today - monthStart).Days + 1;
                    avgHoursPerDay = (decimal)(totalHours / daysInMonth);
                }

                // Recent check-ins (last 10, sorted by check-in time)
                recentCheckIns = todayRecords
                    .OrderByDescending(a => a.CheckIn)
                    .ToList();

                // Active employees (checked in but not checked out)
                activeEmployees = todayRecords
                    .Where(a => a.CheckOut == null)
                    .OrderBy(a => a.CheckIn)
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load dashboard data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetWorkingDuration(AttendanceDto attendance)
    {
        var duration = DateTime.Now - attendance.CheckIn;
        return $"{(int)duration.TotalHours}h {duration.Minutes}m";
    }

    // DTOs
    public class UserDto
    {
        public int UserId { get; set; }
        public string FullName { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
        public string Role { get; set; } = string.Empty;
    }

    public class ShiftTypeDto
    {
        public int ShiftTypeId { get; set; }
        public string Name { get; set; } = string.Empty;
        public TimeSpan StartTime { get; set; }
        public TimeSpan EndTime { get; set; }
    }

    public class AttendanceDto
    {
        public int AttendanceId { get; set; }
        public int UserId { get; set; }
        public int ShiftTypeId { get; set; }
        public DateTime Date { get; set; }
        public DateTime CheckIn { get; set; }
        public DateTime? CheckOut { get; set; }
        public bool IsLate { get; set; }
        public UserDto? User { get; set; }
        public ShiftTypeDto? ShiftType { get; set; }
    }

    // GraphQL Response Types
    private class GetUsersResponse
    {
        public List<UserDto>? Users { get; set; }
    }

    private class GetShiftTypesResponse
    {
        public List<ShiftTypeDto>? ShiftTypes { get; set; }
    }

    private class GetAttendancesResponse
    {
        public List<AttendanceDto>? Attendances { get; set; }
    }
}
