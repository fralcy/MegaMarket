@page "/admin/shift-types"
@attribute [Authorize(Roles = "Admin")]
@using MegaMarket.Data.Models
@using MegaMarket.API.DTOs
@inject Services.ShiftTypes.ShiftTypesApiClient ShiftTypesApiClient
@inject NavigationManager NavigationManager

<div class="container-fluid mt-4">
    @* Header *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-gradient mb-1">Shift Type Management</h2>
            <p class="text-muted">Manage work shift schedules and wage rates</p>
        </div>
        <button class="btn btn-primary" @onclick="ShowCreateModal">
            <span class="bi bi-plus-lg me-1"></span> Add Shift Type
        </button>
    </div>

    @* Stats Cards *@
    <div class="row mb-4">
        <div class="col-md-4">
            <StatsCard
                Title="Total Shift Types"
                Value="@totalShiftTypes.ToString()"
                SubLabel="Active shifts"
                Color="primary" />
        </div>
        <div class="col-md-4">
            <StatsCard
                Title="Average Wage"
                Value="@($"${averageWage:F2}/hr")"
                SubLabel="Per hour"
                Color="success" />
        </div>
        <div class="col-md-4">
            <StatsCard
                Title="Shifts Today"
                Value="@activeShiftsToday.ToString()"
                SubLabel="Currently active"
                Color="info" />
        </div>
    </div>

    @* Error Message *@
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <ErrorAlert ErrorMessage="@errorMessage" OnDismiss="@(() => errorMessage = null)" />
    }

    @* Loading State *@
    @if (isLoading)
    {
        <LoadingSpinner Message="Loading shift types..." />
    }
    else if (shiftTypes == null || !shiftTypes.Any())
    {
        <EmptyState
            Icon="ðŸ“‹"
            Title="No Shift Types Found"
            Description="Create your first shift type to get started with scheduling."
            ActionText="Add Shift Type"
            OnAction="ShowCreateModal" />
    }
    else
    {
        @* Shift Type Grid *@
        <ShiftTypeList
            ShiftTypes="@shiftTypes"
            OnEdit="ShowEditModal"
            OnDelete="ShowDeleteModal" />
    }
</div>

@* Form Modal *@
<ShiftTypeFormModal
    IsVisible="@showFormModal"
    ShiftType="@shiftTypeToEdit"
    OnSave="HandleSaveShiftType"
    OnCancel="HideFormModal" />

@* Delete Confirmation Modal *@
<ConfirmDialog
    IsVisible="@showDeleteModal"
    Title="Delete Shift Type"
    Message="@($"Are you sure you want to delete '{shiftTypeToDelete?.Name}'? This will affect all related attendance records.")"
    OnConfirm="HandleDeleteShiftType"
    OnCancel="HideDeleteModal" />

@code {
    private List<ShiftType>? shiftTypes;
    private bool isLoading = true;
    private string? errorMessage;

    // Stats
    private int totalShiftTypes => shiftTypes?.Count ?? 0;
    private decimal averageWage => shiftTypes?.Any() == true ? shiftTypes.Average(s => s.WagePerHour) : 0;
    private int activeShiftsToday = 0;

    // Modal states
    private bool showFormModal = false;
    private bool showDeleteModal = false;
    private ShiftType? shiftTypeToEdit;
    private ShiftType? shiftTypeToDelete;

    protected override async Task OnInitializedAsync()
    {
        await LoadShiftTypes();
    }

    private async Task LoadShiftTypes()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            shiftTypes = await ShiftTypesApiClient.GetShiftTypesAsync();

            if (shiftTypes == null)
            {
                errorMessage = "Failed to load shift types.";
                shiftTypes = new List<ShiftType>();
            }
            else
            {
                CalculateActiveShiftsToday();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load shift types: {ex.Message}";
            shiftTypes = new List<ShiftType>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void CalculateActiveShiftsToday()
    {
        if (shiftTypes == null) return;

        var currentTime = DateTime.Now.TimeOfDay;
        activeShiftsToday = shiftTypes.Count(s =>
            s.StartTime <= currentTime && s.EndTime >= currentTime);
    }

    private void ShowCreateModal()
    {
        shiftTypeToEdit = null;
        showFormModal = true;
    }

    private void ShowEditModal(ShiftType shiftType)
    {
        shiftTypeToEdit = shiftType;
        showFormModal = true;
    }

    private void ShowDeleteModal(ShiftType shiftType)
    {
        shiftTypeToDelete = shiftType;
        showDeleteModal = true;
    }

    private void HideFormModal()
    {
        showFormModal = false;
        shiftTypeToEdit = null;
    }

    private void HideDeleteModal()
    {
        showDeleteModal = false;
        shiftTypeToDelete = null;
    }

    private async Task HandleSaveShiftType(ShiftTypeFormData formData)
    {
        try
        {
            // Convert form data to DTO
            var input = new ShiftTypeInputDto
            {
                Name = formData.Name,
                StartTime = TimeSpan.Parse(formData.StartTime),
                EndTime = TimeSpan.Parse(formData.EndTime),
                WagePerHour = formData.WagePerHour
            };

            if (shiftTypeToEdit == null)
            {
                // Create new shift type
                await ShiftTypesApiClient.CreateShiftTypeAsync(input);
            }
            else
            {
                // Update existing shift type
                await ShiftTypesApiClient.UpdateShiftTypeAsync(shiftTypeToEdit.ShiftTypeId, input);
            }

            HideFormModal();
            await LoadShiftTypes();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save shift type: {ex.Message}";
        }
    }

    private async Task HandleDeleteShiftType()
    {
        if (shiftTypeToDelete == null) return;

        try
        {
            var success = await ShiftTypesApiClient.DeleteShiftTypeAsync(shiftTypeToDelete.ShiftTypeId);

            if (!success)
            {
                errorMessage = "Failed to delete shift type.";
            }

            HideDeleteModal();
            await LoadShiftTypes();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete shift type: {ex.Message}";
            HideDeleteModal();
        }
    }

    // Form Data (used by the form modal)
    public class ShiftTypeFormData
    {
        public string Name { get; set; } = string.Empty;
        public string StartTime { get; set; } = string.Empty;
        public string EndTime { get; set; } = string.Empty;
        public decimal WagePerHour { get; set; }
    }
}
