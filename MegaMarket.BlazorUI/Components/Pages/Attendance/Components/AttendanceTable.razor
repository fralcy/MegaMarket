@* Attendance Table Component *@
@using MegaMarket.Data.Models
@inject AuthenticationStateProvider AuthStateProvider

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        @if (isAdmin)
                        {
                            <th>Employee</th>
                        }
                        <th>Shift</th>
                        <th>Check In</th>
                        <th>Check Out</th>
                        <th>Work Time</th>
                        <th>Status</th>
                        <th>Wage</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var attendance in Attendances ?? new List<MegaMarket.Data.Models.Attendance>())
                    {
                        <tr>
                            <td>
                                <strong>@attendance.Date.ToString("MMM dd, yyyy")</strong>
                                <br />
                                <small class="text-muted">@attendance.Date.ToString("dddd")</small>
                            </td>
                            @if (isAdmin)
                            {
                                <td>
                                    @attendance.User?.FullName
                                    <br />
                                    <small class="text-muted">@attendance.User?.Username</small>
                                </td>
                            }
                            <td>
                                <span class="badge bg-secondary">@attendance.ShiftType?.Name</span>
                                <br />
                                <small class="text-muted">@FormatTime(attendance.ShiftType?.StartTime) - @FormatTime(attendance.ShiftType?.EndTime)</small>
                            </td>
                            <td>
                                @if (attendance.CheckIn != null)
                                {
                                    @attendance.CheckIn.Value.ToString("h:mm tt")
                                }
                                else
                                {
                                    <span class="text-muted">N/A</span>
                                }
                            </td>
                            <td>
                                @if (attendance.CheckOut != null)
                                {
                                    @attendance.CheckOut.Value.ToString("h:mm tt")
                                }
                                else
                                {
                                    <span class="text-muted">Not checked out</span>
                                }
                            </td>
                            <td>
                                @if (attendance.CheckOut != null && attendance.CheckIn != null)
                                {
                                    var duration = attendance.CheckOut.Value - attendance.CheckIn.Value;
                                    <span>@((int)duration.TotalHours)h @duration.Minutes m</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (attendance.CheckOut == null)
                                {
                                    <StatusBadge Status="Pending" />
                                }
                                else if (attendance.IsLate)
                                {
                                    <StatusBadge Status="Late" />
                                }
                                else
                                {
                                    <StatusBadge Status="On Time" />
                                }
                            </td>
                            <td>
                                @if (attendance.CheckOut != null && attendance.CheckIn != null)
                                {
                                    var duration = attendance.CheckOut.Value - attendance.CheckIn.Value;
                                    var wage = (decimal)duration.TotalHours * (attendance.ShiftType?.WagePerHour ?? 0);
                                    <strong class="text-success">$@wage.ToString("F2")</strong>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @* Summary Row *@
        @if (Attendances != null && Attendances.Any())
        {
            var completedAttendances = Attendances.Where(a => a.CheckOut != null && a.CheckIn != null).ToList();
            var totalHours = completedAttendances.Sum(a => (a.CheckOut!.Value - a.CheckIn!.Value).TotalHours);
            var totalWage = completedAttendances.Sum(a =>
            {
                var duration = a.CheckOut!.Value - a.CheckIn!.Value;
                return (decimal)duration.TotalHours * (a.ShiftType?.WagePerHour ?? 0);
            });

            <div class="alert alert-info mt-3">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Total Work Time:</strong> @((int)totalHours)h @((int)((totalHours - (int)totalHours) * 60))m
                    </div>
                    <div class="col-md-6">
                        <strong>Total Wage:</strong> <span class="text-success">$@totalWage.ToString("F2")</span>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public List<MegaMarket.Data.Models.Attendance>? Attendances { get; set; }

    private bool isAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAdmin = user.IsInRole("Admin");
    }

    private string FormatTime(TimeSpan? time)
    {
        if (time == null) return "N/A";
        return DateTime.Today.Add(time.Value).ToString("h:mm tt");
    }
}
