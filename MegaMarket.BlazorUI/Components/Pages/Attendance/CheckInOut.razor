@page "/attendance/check-in-out"
@attribute [Authorize]
@using MegaMarket.Data.Models
@inject Services.Users.UsersApiClient UsersApiClient
@inject Services.ShiftTypes.ShiftTypesApiClient ShiftTypesApiClient
@inject Services.Attendance.AttendanceApiClient AttendanceApiClient
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

<div class="container mt-4">
    @* Header *@
    <div class="text-center mb-4">
        <h2 class="text-gradient mb-1">Attendance Check-In/Out</h2>
        <p class="text-muted">Mark your attendance for today's shift</p>
    </div>

    @* Error Message *@
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <ErrorAlert ErrorMessage="@errorMessage" OnDismiss="@(() => errorMessage = null)" />
    }

    @* Success Message *@
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show">
            <strong>âœ“ Success:</strong> @successMessage
            <button class="btn-close" @onclick="@(() => successMessage = null)"></button>
        </div>
    }

    @* Loading State *@
    @if (isLoading)
    {
        <LoadingSpinner Message="Loading attendance status..." />
    }
    else
    {
        @* Check-In/Out Card *@
        <CheckInOutCard
            CurrentUser="@currentUser"
            TodayAttendance="@todayAttendance"
            AvailableShiftTypes="@availableShiftTypes"
            OnCheckIn="HandleCheckIn"
            OnCheckOut="HandleCheckOut" />
    }
</div>

@code {
    private User? currentUser;
    private MegaMarket.Data.Models.Attendance? todayAttendance;
    private List<ShiftType>? availableShiftTypes;
    private bool isLoading = true;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            // Get current user info
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var userIdClaim = user.FindFirst("userId")?.Value;

            if (string.IsNullOrEmpty(userIdClaim) || !int.TryParse(userIdClaim, out var userId))
            {
                errorMessage = "Unable to identify current user. Please log in again.";
                return;
            }

            // Load user info
            currentUser = await UsersApiClient.GetUserAsync(userId);

            if (currentUser == null)
            {
                errorMessage = "Failed to load user information.";
                return;
            }

            // Load today's attendance
            var userAttendances = await AttendanceApiClient.GetAttendancesByUserAsync(userId);
            if (userAttendances != null)
            {
                todayAttendance = userAttendances
                    .FirstOrDefault(a => a.Date.Date == DateTime.Today);
            }

            // Load available shift types
            availableShiftTypes = await ShiftTypesApiClient.GetShiftTypesAsync();
            if (availableShiftTypes == null)
            {
                availableShiftTypes = new List<ShiftType>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleCheckIn(int shiftTypeId)
    {
        try
        {
            if (currentUser == null)
            {
                errorMessage = "User information not available";
                return;
            }

            errorMessage = null;
            successMessage = null;

            // Create attendance record if it doesn't exist
            if (todayAttendance == null)
            {
                var attendanceInput = new MegaMarket.API.DTOs.AttendanceInputDto
                {
                    UserId = currentUser.UserId,
                    ShiftTypeId = shiftTypeId,
                    Date = DateTime.Today
                };

                todayAttendance = await AttendanceApiClient.CreateAttendanceAsync(attendanceInput);
            }

            // Now check in
            var result = await AttendanceApiClient.CheckInAsync(currentUser.UserId, DateTime.Today);

            if (result != null)
            {
                todayAttendance = result;
                var status = todayAttendance?.IsLate == true ? "late" : "on time";
                successMessage = $"Checked in successfully at {DateTime.Now:h:mm tt} ({status})!";
            }
            else
            {
                errorMessage = "Failed to check in.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to check in: {ex.Message}";
        }
    }

    private async Task HandleCheckOut()
    {
        if (todayAttendance == null || currentUser == null)
        {
            errorMessage = "No check-in record found for today";
            return;
        }

        try
        {
            errorMessage = null;
            successMessage = null;

            var result = await AttendanceApiClient.CheckOutAsync(currentUser.UserId, DateTime.Today);

            if (result != null)
            {
                todayAttendance.CheckOut = result.CheckOut;
                successMessage = $"Checked out successfully at {DateTime.Now:h:mm tt}!";
            }
            else
            {
                errorMessage = "Failed to check out.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to check out: {ex.Message}";
        }
    }

}
