@page "/sale"

@inject IHttpClientFactory HttpClientFactory
@using System.Globalization
@using MegaMarket.API.DTOs.Invoice
@using MegaMarket.API.DTOs.Products
@using MegaMarket.API.DTOs.Promotion
@using MegaMarket.Data.Models

<div class="checkout-container">
    <h2>Point Of Sale</h2>

    @if (!IsPaymentScreenVisible && LastCompletedInvoice == null)
    {
        <div class="product-list-area">
            <h3>Cart list</h3>
            <div class="product-list-header">
                <span class="col-name">Name</span>
                <span class="col-qty">Quantity</span>
                <span class="col-price">Unit Price</span>
                <span class="col-total">Total</span>
                <span class="col-action">Delete</span>
            </div>

            <div class="product-list">
                @if (CartItems.Any())
                {
                    @foreach (var item in CartItems)
                    {
                        <div class="product-item">
                            <span class="col-name">@item.Name</span>
                            <span class="col-qty">@item.Quantity</span>
                            <span class="col-price">@FormatCurrency(item.UnitPrice)</span>
                            <span class="col-total">@FormatCurrency(item.Total)</span>
                            <span class="col-action">
                                <button class="btn-delete" @onclick="() => RemoveItem(item.Barcode)">Delete</button>
                            </span>
                        </div>
                    }
                }
                else
                {
                    <p class="empty-cart">Empty cart.</p>
                }
            </div>

            <hr />

            <div class="total-area">
                <strong>Total amount:</strong>
                <span class="total-amount">@FormatCurrency(OriginalPrice)</span>
            </div>
        </div>

        <div class="input-keypad-area">
            <div class="input-form">
                <div class="input-group">
                    <label for="productCode">Barcode:</label>
                    <input id="productCode" @bind="InputProductCode"
                           placeholder="Input product's barcode" @onfocus="SetFocusToProductCode" />
                </div>

                <div class="input-group">
                    <label> Name:</label>
                    <span>@CurrentProductName</span>
                </div>

                <div class="input-group">
                    <label>Unit Price:</label>
                    <span class="display-price">@FormatCurrency(CurrentUnitPrice)</span>
                </div>

                <div class="input-group">
                    <label for="quantity">Quantity:</label>
                    <input id="quantity" @bind="InputQuantity" type="number" min="1"
                           placeholder="Số lượng" @onfocus="SetFocusToQuantity" />
                </div>

                <div class="input-group">
                    <button class="btn-add" @onclick="AddItem" disabled="@(CurrentUnitPrice == 0 || InputQuantity <= 0)">Add</button>
                </div>
            </div>

            <div class="numeric-keypad">
                <button @onclick="() => AppendToInput('7'.ToString())">7</button>
                <button @onclick="() => AppendToInput('8'.ToString())">8</button>
                <button @onclick="() => AppendToInput('9'.ToString())">9</button>

                <button @onclick="() => AppendToInput('4'.ToString())">4</button>
                <button @onclick="() => AppendToInput('5'.ToString())">5</button>
                <button @onclick="() => AppendToInput('6'.ToString())">6</button>

                <button @onclick="() => AppendToInput('1'.ToString())">1</button>
                <button @onclick="() => AppendToInput('2'.ToString())">2</button>
                <button @onclick="() => AppendToInput('3'.ToString())">3</button>

                <button @onclick="ClearLastInput">CE</button>
                <button @onclick="() => AppendToInput('0'.ToString())">0</button>
                <button @onclick="ClearAllInput">C</button>
            </div>
        </div>

        <hr />

        <div class="action-buttons">
            <button class="btn-primary" @onclick="Checkout" disabled="@(!CartItems.Any())">Checkout</button>
            <button class="btn-secondary" @onclick="CancelTransaction" disabled="@(!CartItems.Any())">Cancel</button>
        </div>
    }
    else if (LastCompletedInvoice == null)
    {
        <h2>Checkout detail</h2>

        <div class="payment-screen">
            <div class="payment-methods">
                <button class="@(SelectedPaymentMethod == PaymentMethod.Cash ? "active" : "")" @onclick="() => SetPaymentMethod(PaymentMethod.Cash)">Cash</button>
                <button class="@(SelectedPaymentMethod == PaymentMethod.BankTransfer ? "active" : "")" @onclick="() => SetPaymentMethod(PaymentMethod.BankTransfer)">Bank transfer</button>
                <button class="@(SelectedPaymentMethod == PaymentMethod.Card ? "active" : "")" @onclick="() => SetPaymentMethod(PaymentMethod.Card)">Card</button>
            </div>

            <div class="financial-summary">
                <div class="summary-row">
                    <span class="summary-label">Before discount:</span>
                    <span class="summary-value">@FormatCurrency(OriginalPrice)</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Discount:</span>
                    <span class="summary-value negative">@FormatCurrency(DiscountAmountCalculated)</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Round:</span>
                    <span class="summary-value">@FormatCurrency(RoundingAmount)</span>
                </div>

                <hr style="grid-column: 1 / -1; margin: 5px 0;" />

                <div class="summary-row">
                    <span class="summary-label"><strong>Amount to collect:</strong></span>
                    <span class="summary-value total negative">@FormatCurrency(AmountToCollect)</span>
                </div>

                <div class="summary-row">
                    <span class="summary-label">Collected:</span>
                    <span class="summary-value">@FormatCurrency(PaidAmountDisplay)</span>
                </div>

                <div class="summary-row">
                    <span class="summary-label">Amout missing:</span>
                    <span class="summary-value negative">@FormatCurrency(AmountMissing)</span>
                </div>

                <div class="summary-row">
                    <span class="summary-label">Change:</span>
                    <span class="summary-value positive">@FormatCurrency(ChangeAmount)</span>
                </div>
            </div>

            <div class="promo-details">
                <strong>Promotion detail:</strong>
                <ul>
                    @foreach (var detail in SelectedPromotion)
                    {
                        <li>@detail.Description</li>
					}
                </ul>
            </div>
        </div>

        @if (SelectedPaymentMethod == PaymentMethod.Cash)
        {
            <div class="input-keypad-area-center">
                <input id="amountPaid"
                       type="number"
                       value="@AmountPaid.ToString("N0", new CultureInfo("vi-VN"))"
                       @oninput="HandleAmountPaid" />

                <div class="numeric-keypad">
                    <button @onclick="() => CollectToInput('7'.ToString())">7</button>
                    <button @onclick="() => CollectToInput('8'.ToString())">8</button>
                    <button @onclick="() => CollectToInput('9'.ToString())">9</button>

                    <button @onclick="() => CollectToInput('4'.ToString())">4</button>
                    <button @onclick="() => CollectToInput('5'.ToString())">5</button>
                    <button @onclick="() => CollectToInput('6'.ToString())">6</button>

                    <button @onclick="() => CollectToInput('1'.ToString())">1</button>
                    <button @onclick="() => CollectToInput('2'.ToString())">2</button>
                    <button @onclick="() => CollectToInput('3'.ToString())">3</button>

                    <button @onclick="ClearLastInput">CE</button>
                    <button @onclick="() => CollectToInput('0'.ToString())">0</button>
                    <button @onclick="ClearAllInput">C</button>
                </div>
            </div>
        }

        <div class="action-buttons">
            <button class="btn-primary" @onclick="FinalizePayment" disabled="@(AmountMissing > 0)">Done</button>
            <button class="btn-secondary" @onclick="CancelPaymentScreen">Cancel</button>
        </div>
    }
    else if (LastCompletedInvoice != null)
    {
        <div class="invoice-completed-view">

            <div class="invoice-confirmation-panel">
                <h4>Invoice #@LastCompletedInvoice.InvoiceId completed!</h4>

                <div class="receipt-actions">
                    <button class="btn-primary" @onclick="PrintReceipt">🖨️ Print</button>
                    <button class="btn-success" @onclick="ResetToNewTransaction">⬅️ Back</button>
                </div>
            </div>

            <div class="receipt-preview-panel">
                <div class="print-content">
                    <div class="receipt-header">
                        <strong>HÓA ĐƠN SIÊU THỊ MAXIMART</strong><br />
                        <small>Địa chỉ: 123 Lê Lợi, TP.HCM</small>
                    </div>

                    <div class="receipt-divider"></div>

                    <div class="receipt-line"><span>Mã HĐ:</span> <span>#@LastCompletedInvoice.InvoiceId</span></div>
                    <div class="receipt-line"><span>Ngày:</span> <span>@LastCompletedInvoice.CreatedAt.ToString("dd/MM/yyyy HH:mm:ss")</span></div>
                    <div class="receipt-line"><span>NV:</span> <span>@LastCompletedInvoice.User.FullName</span></div>
                    <div class="receipt-line"><span>PTTT:</span> <span>@LastCompletedInvoice.PaymentMethod</span></div>

                    <div class="receipt-divider"></div>

                    @foreach (var detail in LastCompletedInvoice.InvoiceDetails)
                    {
                        var totalPerItem = detail.Quantity * detail.UnitPrice;
                        <div class="receipt-line">
                            <span style="max-width: 60%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">@detail.Product.Name</span>
                            <span>@detail.Quantity x @FormatCurrency(detail.UnitPrice)</span>
                        </div>
                        <div class="receipt-line">
                            <span style="font-size: 0.8em; color: #6c757d;">KM: @FormatCurrency(detail.DiscountPerUnit)</span>
                            <span style="text-align: right;">@FormatCurrency(detail.Quantity * (detail.UnitPrice - detail.DiscountPerUnit))</span>
                        </div>
                    }

                    <div class="receipt-divider"></div>

                    <div class="receipt-line"><span>Tổng (trước KM):</span> <span>@FormatCurrency(LastCompletedInvoice.TotalBeforeDiscount)</span></div>
                    <div class="receipt-line"><span>Khuyến mãi:</span> <span class="negative">@FormatCurrency(LastCompletedInvoice.TotalBeforeDiscount - LastCompletedInvoice.TotalAmount)</span></div>
                    <div class="receipt-line receipt-total"><span>TỔNG CỘNG:</span> <span>@FormatCurrency(LastCompletedInvoice.TotalAmount)</span></div>

                    <div class="receipt-divider"></div>

                    <div class="receipt-line"><span>Khách trả:</span> <span>@FormatCurrency(LastCompletedInvoice.ReceivedAmount)</span></div>
                    <div class="receipt-line"><span>Tiền thừa:</span> <span class="positive">@FormatCurrency(LastCompletedInvoice.ChangeAmount)</span></div>

                    <div class="receipt-footer">
                        <p>Cảm ơn quý khách!</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<ProductDto> Products = new List<ProductDto>();
    private Dictionary<string, ProductDto> ProductDB;
    private List<PromotionResDto> Promotions { get; set; } = new List<PromotionResDto>();
    private List<PromotionProductResDto> PromotionProducts = new List<PromotionProductResDto>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("MegaMarket.API");
            Products = await client.GetFromJsonAsync<List<ProductDto>>("api/Products") ?? new List<ProductDto>();
            Promotions = await client.GetFromJsonAsync<List<PromotionResDto>>("api/Promotion") ?? new List<PromotionResDto>();
            PromotionProducts = await client.GetFromJsonAsync<List<PromotionProductResDto>>("api/Promotion/PromotionProduct") ?? new List<PromotionProductResDto>();
            ProductDB = Products.ToDictionary(p => p.Barcode, p => p);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Lỗi khi tải danh sách sản phẩm: {ex.Message}");
            Products = new List<ProductDto>();
            Promotions = new List<PromotionResDto>();
            PromotionProducts = new List<PromotionProductResDto>();
            ProductDB = new Dictionary<string, ProductDto>();
        }
    }


    // -----------------------------------------------------------------------
    // ENUM VÀ STATE (Trạng thái)
    // -----------------------------------------------------------------------

    public class CartItem
    {
        public int ProductId { get; set; }
        public string Barcode { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public int Quantity { get; set; }
        public decimal UnitPrice { get; set; }
        public decimal? DiscountPerUnit { get; set; } = 0;
        public decimal Total => Quantity * UnitPrice;
    }

    public enum PaymentMethod
    {
        Cash,
        BankTransfer,
        Card
    }

    private List<CartItem> CartItems = new List<CartItem>();
    private string InputProductCode { get; set; } = "";
    private string InputQuantityText { get; set; } = "1";
    private decimal CurrentUnitPrice { get; set; } = 0;
    private string CurrentProductName { get; set; } = "";
    private string CurrentFocusedInput { get; set; } = "ProductCode";

    // Trạng thái màn hình thanh toán
    private bool IsPaymentScreenVisible { get; set; } = false;
    private PaymentMethod SelectedPaymentMethod { get; set; } = PaymentMethod.Cash;
    private decimal AmountPaid { get; set; } = 0;
    private string AmountPaidInput { get; set; } = "";
    private List<PromotionResDto> SelectedPromotion = new List<PromotionResDto>();
    private Invoice? LastCompletedInvoice { get; set; }


    // -----------------------------------------------------------------------
    // CÁC THUỘC TÍNH TÍNH TOÁN
    // -----------------------------------------------------------------------

    private decimal TotalAmount => CartItems.Sum(item => item.Total);

    // Thuộc tính tính toán cho màn hình thanh toán
    private decimal OriginalPrice { get; set; } = 0;
    private decimal DiscountAmountCalculated { get; set; } = 0;
    private decimal AmountToCollect { get; set; } = 0;
    private decimal RoundingAmount { get; set; } = 0;

    private decimal AmountMissing => AmountToCollect - AmountPaid > 0 ? AmountToCollect - AmountPaid : 0;
    private decimal ChangeAmount => AmountPaid - AmountToCollect > 0 ? AmountPaid - AmountToCollect : 0;
    private decimal PaidAmountDisplay => AmountPaid;

    private int InputQuantity
    {
        get => int.TryParse(InputQuantityText, out var qty) && qty > 0 ? qty : 1;
        set => InputQuantityText = value.ToString();
    }

    // -----------------------------------------------------------------------
    // HÀM XỬ LÝ SỰ KIỆN
    // -----------------------------------------------------------------------

    [Inject]
    public IJSRuntime JSRuntime { get; set; } = default!;
    // Lấy khuyến mãi được chọn (nếu có)
    private void GetSelectedPromotion()
    {
        DateTime today = DateTime.Now;

        var result = Promotions.FirstOrDefault(p => p.StartDate <= today && p.EndDate >= today && p.Type.Equals("invoice", StringComparison.OrdinalIgnoreCase));
        if (result != null)
        {
            SelectedPromotion.Add(result);
        }
    }
    // Định dạng tiền tệ
    private string FormatCurrency(decimal amount)
    {
        var culture = new CultureInfo("vi-VN");
        // Hiển thị số 0 nếu giá trị âm hoặc null, ví dụ: Tiền thừa âm thì hiển thị 0
        if (amount < 0) return string.Format(culture, "-{0:N0} VNĐ", Math.Abs(amount));
        return string.Format(culture, "{0:N0} VNĐ", amount);
    }

    private void CalculateFinancialSummary()
    {
        OriginalPrice = CartItems.Sum(item => item.Total);

        if (SelectedPromotion != null && IsPaymentScreenVisible)
        {
            var sortedList = SelectedPromotion
            .OrderBy(p => p.Type.Equals("product", StringComparison.OrdinalIgnoreCase) ? 1 :
                          p.Type.Equals("invoice", StringComparison.OrdinalIgnoreCase) ? 2 :
            3)
            .ToList();
            foreach (var promo in sortedList)
            {
                if (promo.Type == "product")
                {
                    DiscountAmountCalculated += promo.DiscountValue;
                }
                else if (promo.Type == "invoice" && promo.DiscountType == "fixed")
                {
                    DiscountAmountCalculated += promo.DiscountValue;
                }
                else if (promo.Type == "invoice" && promo.DiscountType == "percent")
                {
                    DiscountAmountCalculated += OriginalPrice * (promo.DiscountValue / 100);
                }
            }
        }
        else
        {
            DiscountAmountCalculated = 0;
        }

        decimal amountBeforeRounding = OriginalPrice - DiscountAmountCalculated;

        // MOCK Làm tròn (Ví dụ: làm tròn xuống bội số 100 gần nhất)
        decimal rounded = Math.Floor(amountBeforeRounding / 100) * 100;

        RoundingAmount = amountBeforeRounding - rounded;
        AmountToCollect = rounded;

        // Nếu không phải tiền mặt, giả định đã thu bằng số cần thu
        if (IsPaymentScreenVisible && SelectedPaymentMethod != PaymentMethod.Cash)
        {
            AmountPaid = AmountToCollect;
        }
    }

    private void UpdateUnitPriceDisplay()
    {
        if (ProductDB.TryGetValue(InputProductCode, out var productInfo))
        {
            CurrentUnitPrice = productInfo.UnitPrice;
            CurrentProductName = productInfo.Name;
        }
        else
        {
            CurrentUnitPrice = 0;
            CurrentProductName = "";
        }
    }

    private void SetFocusToQuantity()
    {
        CurrentFocusedInput = "Quantity";
    }

    private void SetFocusToProductCode()
    {
        CurrentFocusedInput = "ProductCode";
    }

    private void AddItem()
    {
        UpdateUnitPriceDisplay();

        if (string.IsNullOrWhiteSpace(InputProductCode) || CurrentUnitPrice == 0 || InputQuantity <= 0)
        {
            Console.WriteLine("Lỗi: Vui lòng nhập mã sản phẩm hợp lệ và số lượng lớn hơn 0.");
            return;
        }

        var productInfo = ProductDB[InputProductCode];

        var existingItem = CartItems.FirstOrDefault(i => i.Barcode == InputProductCode);

        if (existingItem != null)
        {
            existingItem.Quantity += InputQuantity;
        }
        else
        {
            CartItems.Add(new CartItem
            {
				ProductId = productInfo.ProductId,
                Barcode = InputProductCode,
                Name = productInfo.Name,
                Quantity = InputQuantity,
                UnitPrice = productInfo.UnitPrice,
            });
        }

        // Reset inputs sau khi thêm
        InputProductCode = "";
        InputQuantityText = "1";
        CurrentUnitPrice = 0;
        CurrentProductName = "";
        CurrentFocusedInput = "ProductCode";

        CalculateFinancialSummary(); // <-- CẬP NHẬT TRẠNG THÁI TÀI CHÍNH
    }

    private void RemoveItem(string productId)
    {
        var itemToRemove = CartItems.FirstOrDefault(i => i.Barcode == productId);
        if (itemToRemove != null)
        {
            CartItems.Remove(itemToRemove);
            CalculateFinancialSummary(); // <-- CẬP NHẬT TRẠNG THÁI TÀI CHÍNH
        }
    }

    // Xử lý nút Thanh Toán cũ
    private void Checkout()
    {
        if (CartItems.Any())
        {
            IsPaymentScreenVisible = true;
            GetSelectedPromotion();
            foreach(var item in CartItems)
            {
                var query = PromotionProducts
                .Where(pp => pp.ProductId == item.ProductId)
                .Select(p => p.Promotion)
                .Where(p => p.StartDate <= DateTime.Today && p.EndDate >= DateTime.Today)
                .FirstOrDefault();

                // Console.WriteLine($"Kiểm tra khuyến mãi cho sản phẩm {item.Name}: {(query != null ? query : "Không có")}");
                if (query != null)
                {
                    SelectedPromotion.Add(query);
                }
            }

            foreach(var item in CartItems)
            {
                var applicablePromotion = SelectedPromotion
                    .Where(promo => promo.Type.Equals("product", StringComparison.OrdinalIgnoreCase))
                    .SelectMany(promo => promo.PromotionProducts)
                    // .Where(pp => pp.ProductId == item.ProductId)
                    // .Select(pp => pp.Promotion)
                    // .FirstOrDefault()
                    ;
				// Console.WriteLine($"Áp dụng khuyến mãi cho sản phẩm {item.Name}: {(applicablePromotion != null ? applicablePromotion.Description : "Không có")}");
                foreach(var promo in applicablePromotion)
                {
					Console.WriteLine($"Áp dụng khuyến mãi cho sản phẩm {item.Name}: {promo.ProductId}");
				}
    //             if (applicablePromotion != null)
    //             {
    //                 item.DiscountPerUnit = applicablePromotion.DiscountValue;
    //             }
    //             else
    //             {
    //                 item.DiscountPerUnit = 1;
				// }
            }

            CurrentFocusedInput = "AmountPaid";
            CalculateFinancialSummary(); // Tính toán lại số tiền lần cuối
            AmountPaidInput = "";
            AmountPaid = 0; // Gán tiền đã thu ban đầu bằng tiền cần thu

            // Nếu không phải tiền mặt, tự động set phương thức để trigger AmountPaid
            if (SelectedPaymentMethod != PaymentMethod.Cash)
            {
                SetPaymentMethod(SelectedPaymentMethod);
            }

            Console.WriteLine("Hiển thị màn hình thanh toán.");
        }
        else
        {
            Console.WriteLine("Lỗi: Giỏ hàng trống.");
        }
    }

    // Hàm mới: Hủy thanh toán trên màn hình thanh toán
    private void CancelPaymentScreen()
    {
		CurrentFocusedInput = "ProductCode";
        IsPaymentScreenVisible = false;
        AmountPaid = 0;
        SelectedPaymentMethod = PaymentMethod.Cash;
		SelectedPromotion.Clear();
		DiscountAmountCalculated = 0;
        Console.WriteLine("Hủy thanh toán, quay lại màn hình giỏ hàng.");
    }

    private InvoiceReqDto CreateCompletedInvoiceObject()
    {
        // Giả lập dữ liệu cần thiết cho Invoice
        var user = new User { UserId = 1, Username = "Lê Văn Tèo" }; // Giả lập thu ngân
        var customer = new Customer { CustomerId = 1, FullName = "Khách hàng" }; // Giả lập khách hàng

        // Tạo chi tiết hóa đơn từ CartItems
        var invoiceDetails = CartItems.Select(item =>
        {
            if (!ProductDB.TryGetValue(item.Barcode, out var productInfo))
            {
                Console.Error.WriteLine($"Lỗi: Không tìm thấy ProductId cho Barcode: {item.Barcode}");
                return null;
            }

            return new InvoiceDetailReqDto
            {
                ProductId = productInfo.ProductId,
                Quantity = item.Quantity,
                UnitPrice = item.UnitPrice,
				DiscountPerUnit = item.DiscountPerUnit ?? 2
            };
        })
        .Where(detail => detail != null)
        .ToList();

		var query = SelectedPromotion.FirstOrDefault(p => p.Type == "invoice");
        return new InvoiceReqDto
        {
            TotalBeforeDiscount = OriginalPrice,
            TotalAmount = AmountToCollect, // Số tiền sau KM và làm tròn
            PaymentMethod = SelectedPaymentMethod.ToString(),
            ReceivedAmount = AmountPaid,
            ChangeAmount = ChangeAmount,
            PromotionId = query.PromotionId,
            InvoiceDetails = invoiceDetails
        };
    }

    // Hàm mới: Hoàn tất thanh toán
    private async Task FinalizePayment()
    {
        if (AmountPaid >= AmountToCollect)
        {
            Console.WriteLine($"Giao dịch THÀNH CÔNG! Phương thức: {SelectedPaymentMethod}. Cần thu: {FormatCurrency(AmountToCollect)}. Khách trả: {FormatCurrency(AmountPaid)}. Tiền thừa: {FormatCurrency(ChangeAmount)}");
            var newInvoice = CreateCompletedInvoiceObject();
            var client = HttpClientFactory.CreateClient("MegaMarket.API");
            var response = await client.PostAsJsonAsync("api/Invoice", newInvoice);
            if (response.IsSuccessStatusCode)
            {
                LastCompletedInvoice = await response.Content.ReadFromJsonAsync<Invoice>();
                IsPaymentScreenVisible = false;
                Console.WriteLine($"Hóa đơn #{LastCompletedInvoice.InvoiceId} đã được lưu vào hệ thống.");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.Error.WriteLine($"Lỗi khi lưu hóa đơn (Status: {response.StatusCode}): {errorContent}");
                return;
            }
        }
        else
        {
            Console.WriteLine("Lỗi: Số tiền đã thu không đủ để thanh toán.");
        }
    }

    private void ResetToNewTransaction()
    {
        // Dọn dẹp trạng thái
        CancelTransaction(); // Xóa giỏ hàng, reset input
		CurrentFocusedInput = "ProductCode";
        LastCompletedInvoice = null; // Trở về màn hình giỏ hàng
        IsPaymentScreenVisible = false;
		AmountPaidInput = "";
        AmountPaid = 0;
        SelectedPaymentMethod = PaymentMethod.Cash;
		SelectedPromotion.Clear();

        Console.WriteLine("Quay về giao dịch mới.");
    }

    private void SetPaymentMethod(PaymentMethod method)
    {
        SelectedPaymentMethod = method;
        if (method != PaymentMethod.Cash)
        {
            AmountPaid = AmountToCollect;
        }
        else
        {
            // Trở về mặc định số cần thu để dễ nhập liệu tiền thừa
            AmountPaid = 0;
        }
    }

    private void HandleAmountPaid(ChangeEventArgs e)
    {
        string value = e.Value?.ToString() ?? "0";
        // Loại bỏ ký tự phân cách hàng nghìn (dấu chấm)
        value = value.Replace(".", "").Replace(",", "");

        if (decimal.TryParse(value, out var amount))
        {
            AmountPaid = amount;
        }
        else
        {
            // Nếu nhập không hợp lệ, giữ nguyên giá trị cũ hoặc reset về 0
            AmountPaid = 0;
        }
    }

    // Xử lý nút Hủy Bỏ cũ (cho màn hình giỏ hàng)
    private void CancelTransaction()
    {
        CartItems.Clear();
        InputProductCode = "";
        InputQuantityText = "1";
        CurrentUnitPrice = 0;
        CurrentProductName = "";

        CalculateFinancialSummary(); // Reset lại số tiền

        Console.WriteLine("Giao dịch đã được hủy bỏ.");
    }

    // -----------------------------------------------------------------------
    // HÀM XỬ LÝ BÀN PHÍM SỐ (KHÔNG THAY ĐỔI)
    // -----------------------------------------------------------------------

    private void AppendToInput(string number)
    {
        if (CurrentFocusedInput == "ProductCode")
        {
            InputProductCode += number;
            UpdateUnitPriceDisplay();
        }
        else if (CurrentFocusedInput == "Quantity")
        {
            if (InputQuantityText == "0")
            {
                InputQuantityText = number;
            }
            else
            {
                InputQuantityText += number;
            }
        }
    }

    private void CollectToInput(string number)
    {
        AmountPaidInput += number;
        AmountPaid = Convert.ToDecimal(AmountPaidInput);
    }

    private void ClearLastInput()
    {
        if (CurrentFocusedInput == "ProductCode" && InputProductCode.Length > 0)
        {
            InputProductCode = InputProductCode.Substring(0, InputProductCode.Length - 1);
            UpdateUnitPriceDisplay();
        }
        else if (CurrentFocusedInput == "Quantity" && InputQuantityText.Length > 0)
        {
            InputQuantityText = InputQuantityText.Substring(0, InputQuantityText.Length - 1);
            if (string.IsNullOrWhiteSpace(InputQuantityText)) InputQuantityText = "1";
        }
		else if (CurrentFocusedInput == "AmountPaid" && AmountPaidInput.Length > 0)
        {
            AmountPaidInput = AmountPaidInput.Substring(0, AmountPaidInput.Length - 1);
            AmountPaid = string.IsNullOrWhiteSpace(AmountPaidInput) ? 0 : Convert.ToDecimal(AmountPaidInput);
		}
    }

    private void ClearAllInput()
    {
        if (CurrentFocusedInput == "ProductCode")
        {
            InputProductCode = "";
            CurrentUnitPrice = 0;
            CurrentProductName = "";
        }
        else if (CurrentFocusedInput == "Quantity")
        {
            InputQuantityText = "1";
        }
		else if (CurrentFocusedInput == "AmountPaid")
        {
            AmountPaidInput = "";
			AmountPaid = 0;
        }
    }

    private async Task PrintReceipt()
    {
        if (LastCompletedInvoice == null) return;

        // **Lưu ý:** Cần CSS media print để chỉ in phần hóa đơn
        await JSRuntime.InvokeVoidAsync("alert", $"Đang gửi lệnh in hóa đơn #{LastCompletedInvoice.InvoiceId}");

        // Giả lập lệnh in
        // await JSRuntime.InvokeVoidAsync("window.print");
    }
}