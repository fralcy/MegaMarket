@page "/sale"

@inject IHttpClientFactory HttpClientFactory
@using System.Globalization
@using MegaMarket.API.DTOs.Invoice
@using MegaMarket.API.DTOs.Products
@using MegaMarket.Data.Models

<div class="checkout-container">
    <h2>Point Of Sale</h2>

    @if (!IsPaymentScreenVisible && LastCompletedInvoice == null)
    {
        <div class="product-list-area">
            <h3>Cart list</h3>
            <div class="product-list-header">
                <span class="col-name">Name</span>
                <span class="col-qty">Quantity</span>
                <span class="col-price">Unit Price</span>
                <span class="col-total">Total</span>
                <span class="col-action">Delete</span>
            </div>

            <div class="product-list">
                @if (CartItems.Any())
                {
                    @foreach (var item in CartItems)
                    {
                        <div class="product-item">
                            <span class="col-name">@item.Name</span>
                            <span class="col-qty">@item.Quantity</span>
                            <span class="col-price">@FormatCurrency(item.UnitPrice)</span>
                            <span class="col-total">@FormatCurrency(item.Total)</span>
                            <span class="col-action">
                                <button class="btn-delete" @onclick="() => RemoveItem(item.Barcode)">Delete</button>
                            </span>
                        </div>
                    }
                }
                else
                {
                    <p class="empty-cart">Empty cart.</p>
                }
            </div>

            <hr />

            <div class="total-area">
                <strong>Total amount:</strong>
                <span class="total-amount">@FormatCurrency(OriginalPrice)</span>
            </div>
        </div>

        <div class="input-keypad-area">
            <div class="input-form">
                <div class="input-group">
                    <label for="productCode">Barcode:</label>
                    <input id="productCode" @bind="InputProductCode"
                           placeholder="Input product's barcode" @onfocus="SetFocusToProductCode" />
                </div>

                <div class="input-group">
                    <label> Name:</label>
                    <span>@CurrentProductName</span>
                </div>

                <div class="input-group">
                    <label>Unit Price:</label>
                    <span class="display-price">@FormatCurrency(CurrentUnitPrice)</span>
                </div>

                <div class="input-group">
                    <label for="quantity">Quantity:</label>
                    <input id="quantity" @bind="InputQuantity" type="number" min="1"
                           placeholder="Số lượng" @onfocus="SetFocusToQuantity" />
                </div>

                <div class="input-group">
                    <button class="btn-add" @onclick="AddItem" disabled="@(CurrentUnitPrice == 0 || InputQuantity <= 0)">Add</button>
                </div>
            </div>

            <div class="numeric-keypad">
                <button @onclick="() => AppendToInput('7'.ToString())">7</button>
                <button @onclick="() => AppendToInput('8'.ToString())">8</button>
                <button @onclick="() => AppendToInput('9'.ToString())">9</button>

                <button @onclick="() => AppendToInput('4'.ToString())">4</button>
                <button @onclick="() => AppendToInput('5'.ToString())">5</button>
                <button @onclick="() => AppendToInput('6'.ToString())">6</button>

                <button @onclick="() => AppendToInput('1'.ToString())">1</button>
                <button @onclick="() => AppendToInput('2'.ToString())">2</button>
                <button @onclick="() => AppendToInput('3'.ToString())">3</button>

                <button @onclick="ClearLastInput">CE</button>
                <button @onclick="() => AppendToInput('0'.ToString())">0</button>
                <button @onclick="ClearAllInput">C</button>
            </div>
        </div>

        <hr />

        <div class="action-buttons">
            <button class="btn-primary" @onclick="Checkout" disabled="@(!CartItems.Any())">Checkout</button>
            <button class="btn-secondary" @onclick="CancelTransaction" disabled="@(!CartItems.Any())">Cancel</button>
        </div>
    }
    else if (LastCompletedInvoice == null)
    {
        <div class="payment-screen-wrapper">
            <div class="payment-screen single-column">

                <h3>Checkout detail</h3>

                <div class="payment-methods">
                    <button class="@(SelectedPaymentMethod == PaymentMethod.Cash ? "active" : "")" @onclick="() => SetPaymentMethod(PaymentMethod.Cash)">Cash</button>
                    <button class="@(SelectedPaymentMethod == PaymentMethod.BankTransfer ? "active" : "")" @onclick="() => SetPaymentMethod(PaymentMethod.BankTransfer)">Bank transfer</button>
                    <button class="@(SelectedPaymentMethod == PaymentMethod.Card ? "active" : "")" @onclick="() => SetPaymentMethod(PaymentMethod.Card)">Card</button>
                </div>

                <div class="financial-summary">
                    <div class="summary-row">
                        <span class="summary-label">Before discount:</span>
                        <span class="summary-value">@FormatCurrency(OriginalPrice)</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Discount:</span>
                        <span class="summary-value negative">@FormatCurrency(DiscountAmountCalculated)</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Round:</span>
                        <span class="summary-value">@FormatCurrency(RoundingAmount)</span>
                    </div>

                    <hr style="grid-column: 1 / -1; margin: 5px 0;" />

                    <div class="summary-row">
                        <span class="summary-label"><strong>Amount to collect:</strong></span>
                        <span class="summary-value total negative">@FormatCurrency(AmountToCollect)</span>
                    </div>

                    @if (SelectedPaymentMethod == PaymentMethod.Cash)
                    {
                        <div class="payment-input-group" style="grid-column: 1 / -1;">
                            <label for="amountPaid">Collected:</label>
                            <input id="amountPaid"
                                   type="number"
                                   value="@AmountPaidInput.ToString("N0", new CultureInfo("vi-VN"))"
                                   @onchange="HandleAmountPaidInput"
                                   />
                        </div>
                    }
                    else
                    {
                        <div class="summary-row">
                            <span class="summary-label">Collected:</span>
                            <span class="summary-value">@FormatCurrency(PaidAmountDisplay)</span>
                        </div>
                    }

                    <div class="summary-row">
                        <span class="summary-label">Amout missing:</span>
                        <span class="summary-value negative">@FormatCurrency(AmountMissing)</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">Change:</span>
                        <span class="summary-value positive">@FormatCurrency(ChangeAmount)</span>
                    </div>
                </div>

                <div class="promo-details">
                    <strong>Promotion detail:</strong> @DiscountDetails
                </div>

                <div class="action-buttons">
                    <button class="btn-primary" @onclick="FinalizePayment" disabled="@(AmountMissing > 0)">Done</button>
                    <button class="btn-secondary" @onclick="CancelPaymentScreen">Cancel</button>
                </div>
            </div>
        </div>
    }
    else if (LastCompletedInvoice != null)
    {
        <div class="invoice-completed-view">

            <div class="invoice-confirmation-panel">
                <h4>Invoice #@LastCompletedInvoice.InvoiceId completed!</h4>

                <div class="receipt-actions">
                    <button class="btn-primary" @onclick="PrintReceipt">🖨️ Print</button>
                    <button class="btn-success" @onclick="ResetToNewTransaction">⬅️ Back</button>
                </div>
            </div>

            <div class="receipt-preview-panel">
                <div class="print-content">
                    <div class="receipt-header">
                        <strong>HÓA ĐƠN SIÊU THỊ MAXIMART</strong><br />
                        <small>Địa chỉ: 123 Lê Lợi, TP.HCM</small>
                    </div>

                    <div class="receipt-divider"></div>

                    <div class="receipt-line"><span>Mã HĐ:</span> <span>#@LastCompletedInvoice.InvoiceId</span></div>
                    <div class="receipt-line"><span>Ngày:</span> <span>@LastCompletedInvoice.CreatedAt.ToString("dd/MM/yyyy HH:mm:ss")</span></div>
                    <div class="receipt-line"><span>NV:</span> <span>@LastCompletedInvoice.User.FullName</span></div>
                    <div class="receipt-line"><span>PTTT:</span> <span>@LastCompletedInvoice.PaymentMethod</span></div>

                    <div class="receipt-divider"></div>

                    @foreach (var detail in LastCompletedInvoice.InvoiceDetails)
                    {
                        var totalPerItem = detail.Quantity * detail.UnitPrice;
                        <div class="receipt-line">
                            <span style="max-width: 60%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">@detail.Product.Name</span>
                            <span>@detail.Quantity x @FormatCurrency(detail.UnitPrice)</span>
                        </div>
                        <div class="receipt-line">
                            <span style="font-size: 0.8em; color: #6c757d;">KM: @FormatCurrency(detail.DiscountPerUnit)</span>
                            <span style="text-align: right;">@FormatCurrency(detail.Quantity * (detail.UnitPrice - detail.DiscountPerUnit))</span>
                        </div>
                    }

                    <div class="receipt-divider"></div>

                    <div class="receipt-line"><span>Tổng (trước KM):</span> <span>@FormatCurrency(LastCompletedInvoice.TotalBeforeDiscount)</span></div>
                    <div class="receipt-line"><span>Khuyến mãi:</span> <span class="negative">@FormatCurrency(LastCompletedInvoice.TotalBeforeDiscount - LastCompletedInvoice.TotalAmount)</span></div>
                    <div class="receipt-line receipt-total"><span>TỔNG CỘNG:</span> <span>@FormatCurrency(LastCompletedInvoice.TotalAmount)</span></div>

                    <div class="receipt-divider"></div>

                    <div class="receipt-line"><span>Khách trả:</span> <span>@FormatCurrency(LastCompletedInvoice.ReceivedAmount)</span></div>
                    <div class="receipt-line"><span>Tiền thừa:</span> <span class="positive">@FormatCurrency(LastCompletedInvoice.ChangeAmount)</span></div>

                    <div class="receipt-footer">
                        <p>Cảm ơn quý khách!</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<ProductDto> Products = new List<ProductDto>();
    private Dictionary<string, ProductDto> ProductDB;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("MegaMarket.API");
            Products = await httpClient.GetFromJsonAsync<List<ProductDto>>("api/Products") ?? new List<ProductDto>();
            ProductDB = Products.ToDictionary(p => p.Barcode, p => p);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Lỗi khi tải danh sách sản phẩm: {ex.Message}");
            Products = new List<ProductDto>();
            ProductDB = new Dictionary<string, ProductDto>();
        }
    }


    // -----------------------------------------------------------------------
    // ENUM VÀ STATE (Trạng thái)
    // -----------------------------------------------------------------------

    public class CartItem
    {
        public string Barcode { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public int Quantity { get; set; }
        public decimal UnitPrice { get; set; }
        public decimal Total => Quantity * UnitPrice;
    }

    public enum PaymentMethod
    {
        Cash,
        BankTransfer,
        Card
    }

    private List<CartItem> CartItems = new List<CartItem>();
    private string InputProductCode { get; set; } = "";
    private string InputQuantityText { get; set; } = "1";
    private decimal CurrentUnitPrice { get; set; } = 0;
    private string CurrentProductName { get; set; } = "";
    private string CurrentFocusedInput { get; set; } = "ProductCode";

    // Trạng thái màn hình thanh toán
    private bool IsPaymentScreenVisible { get; set; } = false;
    private PaymentMethod SelectedPaymentMethod { get; set; } = PaymentMethod.Cash;
    private decimal AmountPaidInput { get; set; } = 0;
    private string DiscountDetails { get; set; } = "Không có khuyến mãi nào được áp dụng.";
    private Invoice? LastCompletedInvoice { get; set; }


    // -----------------------------------------------------------------------
    // CÁC THUỘC TÍNH TÍNH TOÁN
    // -----------------------------------------------------------------------

    private decimal TotalAmount => CartItems.Sum(item => item.Total);

    // Thuộc tính tính toán cho màn hình thanh toán
    private decimal OriginalPrice { get; set; } = 0;
    private decimal DiscountAmountCalculated { get; set; } = 0;
    private decimal AmountToCollect { get; set; } = 0;
    private decimal RoundingAmount { get; set; } = 0;

    private decimal AmountMissing => AmountToCollect - AmountPaidInput > 0 ? AmountToCollect - AmountPaidInput : 0;
    private decimal ChangeAmount => AmountPaidInput - AmountToCollect > 0 ? AmountPaidInput - AmountToCollect : 0;
    private decimal PaidAmountDisplay => AmountPaidInput;

    private int InputQuantity
    {
        get => int.TryParse(InputQuantityText, out var qty) && qty > 0 ? qty : 1;
        set => InputQuantityText = value.ToString();
    }

    // -----------------------------------------------------------------------
    // HÀM XỬ LÝ SỰ KIỆN
    // -----------------------------------------------------------------------

    [Inject]
    public IJSRuntime JSRuntime { get; set; } = default!;
    // Định dạng tiền tệ
    private string FormatCurrency(decimal amount)
    {
        var culture = new CultureInfo("vi-VN");
        // Hiển thị số 0 nếu giá trị âm hoặc null, ví dụ: Tiền thừa âm thì hiển thị 0
        if (amount < 0) return string.Format(culture, "-{0:N0} VNĐ", Math.Abs(amount));
        return string.Format(culture, "{0:N0} VNĐ", amount);
    }

    private void CalculateFinancialSummary()
    {
        OriginalPrice = CartItems.Sum(item => item.Total);

        // MOCK Khuyến mãi (Ví dụ: Giảm 10% nếu tổng > 100k)
        if (OriginalPrice > 100000)
        {
            DiscountAmountCalculated = OriginalPrice * 0.10m;
            DiscountDetails = "Giảm 10% tổng hóa đơn (Áp dụng cho hóa đơn > 100,000 VNĐ).";
        }
        else
        {
            DiscountAmountCalculated = 0;
            DiscountDetails = "Không có khuyến mãi nào được áp dụng.";
        }

        decimal amountBeforeRounding = OriginalPrice - DiscountAmountCalculated;

        // MOCK Làm tròn (Ví dụ: làm tròn xuống bội số 100 gần nhất)
        decimal rounded = Math.Floor(amountBeforeRounding / 100) * 100;

        RoundingAmount = amountBeforeRounding - rounded;
        AmountToCollect = rounded;

        // Nếu không phải tiền mặt, giả định đã thu bằng số cần thu
        if (IsPaymentScreenVisible && SelectedPaymentMethod != PaymentMethod.Cash)
        {
            AmountPaidInput = AmountToCollect;
        }
    }

    private void OnProductCodeChange(ChangeEventArgs e)
    {
        InputProductCode = e.Value?.ToString() ?? "";
        UpdateUnitPriceDisplay();
        Console.WriteLine($"Mã sản phẩm thay đổi: {InputProductCode}");
    }

    private void UpdateUnitPriceDisplay()
    {
        if (ProductDB.TryGetValue(InputProductCode, out var productInfo))
        {
            CurrentUnitPrice = productInfo.UnitPrice;
            CurrentProductName = productInfo.Name;
        }
        else
        {
            CurrentUnitPrice = 0;
            CurrentProductName = "";
        }
    }

    private void SetFocusToQuantity()
    {
        CurrentFocusedInput = "Quantity";
    }

    private void SetFocusToProductCode()
    {
        CurrentFocusedInput = "ProductCode";
    }

    private void AddItem()
    {
        UpdateUnitPriceDisplay();

        if (string.IsNullOrWhiteSpace(InputProductCode) || CurrentUnitPrice == 0 || InputQuantity <= 0)
        {
            Console.WriteLine("Lỗi: Vui lòng nhập mã sản phẩm hợp lệ và số lượng lớn hơn 0.");
            return;
        }

        var productInfo = ProductDB[InputProductCode];

        var existingItem = CartItems.FirstOrDefault(i => i.Barcode == InputProductCode);

        if (existingItem != null)
        {
            existingItem.Quantity += InputQuantity;
        }
        else
        {
            CartItems.Add(new CartItem
            {
                Barcode = InputProductCode,
                Name = productInfo.Name,
                Quantity = InputQuantity,
                UnitPrice = productInfo.UnitPrice
            });
        }

        // Reset inputs sau khi thêm
        InputProductCode = "";
        InputQuantityText = "1";
        CurrentUnitPrice = 0;
        CurrentProductName = "";
        CurrentFocusedInput = "ProductCode";

        CalculateFinancialSummary(); // <-- CẬP NHẬT TRẠNG THÁI TÀI CHÍNH
    }

    private void RemoveItem(string productId)
    {
        var itemToRemove = CartItems.FirstOrDefault(i => i.Barcode == productId);
        if (itemToRemove != null)
        {
            CartItems.Remove(itemToRemove);
            CalculateFinancialSummary(); // <-- CẬP NHẬT TRẠNG THÁI TÀI CHÍNH
        }
    }

    // Xử lý nút Thanh Toán cũ
    private void Checkout()
    {
        if (CartItems.Any())
        {
            CalculateFinancialSummary(); // Tính toán lại số tiền lần cuối
            IsPaymentScreenVisible = true;
            AmountPaidInput = AmountToCollect; // Gán tiền đã thu ban đầu bằng tiền cần thu

            // Nếu không phải tiền mặt, tự động set phương thức để trigger AmountPaidInput
            if (SelectedPaymentMethod != PaymentMethod.Cash)
            {
                SetPaymentMethod(SelectedPaymentMethod);
            }

            Console.WriteLine("Hiển thị màn hình thanh toán.");
        }
        else
        {
            Console.WriteLine("Lỗi: Giỏ hàng trống.");
        }
    }

    // Hàm mới: Hủy thanh toán trên màn hình thanh toán
    private void CancelPaymentScreen()
    {
        IsPaymentScreenVisible = false;
        AmountPaidInput = 0;
        SelectedPaymentMethod = PaymentMethod.Cash;
        DiscountDetails = "Không có khuyến mãi nào được áp dụng.";
        Console.WriteLine("Hủy thanh toán, quay lại màn hình giỏ hàng.");
    }

    private InvoiceReqDto CreateCompletedInvoiceObject()
    {
        // Giả lập dữ liệu cần thiết cho Invoice
        var user = new User { UserId = 1, Username = "Lê Văn Tèo" }; // Giả lập thu ngân
        var customer = new Customer { CustomerId = 1, FullName = "Khách hàng" }; // Giả lập khách hàng

        // Tạo chi tiết hóa đơn từ CartItems
        var invoiceDetails = CartItems.Select(item =>
        {
            if (!ProductDB.TryGetValue(item.Barcode, out var productInfo))
            {
                Console.Error.WriteLine($"Lỗi: Không tìm thấy ProductId cho Barcode: {item.Barcode}");
                return null;
            }

            return new InvoiceDetailReqDto
            {
                ProductId = productInfo.ProductId,
                Quantity = item.Quantity,
                UnitPrice = item.UnitPrice,
                DiscountPerUnit = 0
            };
		})
        .Where(detail => detail != null)
        .ToList();

        return new InvoiceReqDto
        {
            TotalBeforeDiscount = OriginalPrice,
            TotalAmount = AmountToCollect, // Số tiền sau KM và làm tròn
            PaymentMethod = SelectedPaymentMethod.ToString(),
            ReceivedAmount = AmountPaidInput,
            ChangeAmount = ChangeAmount,
            PromotionId = 3,
            InvoiceDetails = invoiceDetails
        };
    }

    // Hàm mới: Hoàn tất thanh toán
    private async Task FinalizePayment()
    {
        if (AmountPaidInput >= AmountToCollect)
        {
            Console.WriteLine($"Giao dịch THÀNH CÔNG! Phương thức: {SelectedPaymentMethod}. Cần thu: {FormatCurrency(AmountToCollect)}. Khách trả: {FormatCurrency(AmountPaidInput)}. Tiền thừa: {FormatCurrency(ChangeAmount)}");
            var newInvoice = CreateCompletedInvoiceObject();
            var httpClient = HttpClientFactory.CreateClient("MegaMarket.API");
            var response = await httpClient.PostAsJsonAsync("api/Invoice", newInvoice);
            if (response.IsSuccessStatusCode)
            {
                LastCompletedInvoice = await response.Content.ReadFromJsonAsync<Invoice>();
                IsPaymentScreenVisible = false;
                Console.WriteLine($"Hóa đơn #{LastCompletedInvoice.InvoiceId} đã được lưu vào hệ thống.");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.Error.WriteLine($"Lỗi khi lưu hóa đơn (Status: {response.StatusCode}): {errorContent}");
                return;
            }
        }
        else
        {
            Console.WriteLine("Lỗi: Số tiền đã thu không đủ để thanh toán.");
        }
    }

    private void ResetToNewTransaction()
    {
        // Dọn dẹp trạng thái
        CancelTransaction(); // Xóa giỏ hàng, reset input

        LastCompletedInvoice = null; // Trở về màn hình giỏ hàng
        IsPaymentScreenVisible = false;
        AmountPaidInput = 0;
        SelectedPaymentMethod = PaymentMethod.Cash;
        DiscountDetails = "Không có khuyến mãi nào được áp dụng.";

        Console.WriteLine("Quay về giao dịch mới.");
    }

    private void SetPaymentMethod(PaymentMethod method)
    {
        SelectedPaymentMethod = method;
        if (method != PaymentMethod.Cash)
        {
            AmountPaidInput = AmountToCollect;
        }
        else
        {
            // Trở về mặc định số cần thu để dễ nhập liệu tiền thừa
            AmountPaidInput = AmountToCollect;
        }
    }

    private void HandleAmountPaidInput(ChangeEventArgs e)
    {
        string value = e.Value?.ToString() ?? "0";
        // Loại bỏ ký tự phân cách hàng nghìn (dấu chấm)
        value = value.Replace(".", "").Replace(",", "");

        if (decimal.TryParse(value, out var amount))
        {
            AmountPaidInput = amount;
        }
        else
        {
            // Nếu nhập không hợp lệ, giữ nguyên giá trị cũ hoặc reset về 0
            AmountPaidInput = 0;
        }
    }

    // Xử lý nút Hủy Bỏ cũ (cho màn hình giỏ hàng)
    private void CancelTransaction()
    {
        CartItems.Clear();
        InputProductCode = "";
        InputQuantityText = "1";
        CurrentUnitPrice = 0;
        CurrentProductName = "";

        CalculateFinancialSummary(); // Reset lại số tiền

        Console.WriteLine("Giao dịch đã được hủy bỏ.");
    }

    // -----------------------------------------------------------------------
    // HÀM XỬ LÝ BÀN PHÍM SỐ (KHÔNG THAY ĐỔI)
    // -----------------------------------------------------------------------

    private void AppendToInput(string number)
    {
        if (CurrentFocusedInput == "ProductCode")
        {
            InputProductCode += number;
            UpdateUnitPriceDisplay();
        }
        else if (CurrentFocusedInput == "Quantity")
        {
            if (InputQuantityText == "0")
            {
                InputQuantityText = number;
            }
            else
            {
                InputQuantityText += number;
            }
        }
    }

    private void ClearLastInput()
    {
        if (CurrentFocusedInput == "ProductCode" && InputProductCode.Length > 0)
        {
            InputProductCode = InputProductCode.Substring(0, InputProductCode.Length - 1);
            UpdateUnitPriceDisplay();
        }
        else if (CurrentFocusedInput == "Quantity" && InputQuantityText.Length > 0)
        {
            InputQuantityText = InputQuantityText.Substring(0, InputQuantityText.Length - 1);
            if (string.IsNullOrWhiteSpace(InputQuantityText)) InputQuantityText = "1";
        }
    }

    private void ClearAllInput()
    {
        if (CurrentFocusedInput == "ProductCode")
        {
            InputProductCode = "";
            CurrentUnitPrice = 0;
            CurrentProductName = "";
        }
        else if (CurrentFocusedInput == "Quantity")
        {
            InputQuantityText = "1";
        }
    }

    private async Task PrintReceipt()
    {
        if (LastCompletedInvoice == null) return;

        // **Lưu ý:** Cần CSS media print để chỉ in phần hóa đơn
        await JSRuntime.InvokeVoidAsync("alert", $"Đang gửi lệnh in hóa đơn #{LastCompletedInvoice.InvoiceId}");

        // Giả lập lệnh in
        // await JSRuntime.InvokeVoidAsync("window.print");
    }
}